<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloque Arm√≥nico Pro: Herramienta de Entrenamiento</title>
    <!-- External libraries for musical and UI functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/vexflow/build/esm/vexflow.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Tailwind CSS for a modern and responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for statistical graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Base document styles */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f1f5f9;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            color: #334155;
            line-height: 1.6;
        }

        /* Main application container */
        .container {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 98%;
            box-sizing: border-box;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }

        /* Styles for the question area */
        #chordQuestionWrapper {
            text-align: center;
        }
        #chordQuestionText strong {
            color: #1e40af;
        }

        /* Container for the staff and note grid */
        #displaySection {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 1rem;
        }

        #questionArea {
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid #dbeafe;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1 1 250px;
        }

        #staffArea {
            flex: 1 1 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
        }
        #musicalStaffCanvas {
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            height: auto;
            max-width: 300px; /* Constrains the display width */
            box-sizing: border-box;
        }

        /* Note grid styles */
        .notes-grid {
            display: grid;
            grid-template-rows: repeat(4, 1fr);
            gap: 4px;
            width: 100%;
            max-width: 200px;
        }
        .grid-cell {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            font-weight: 600;
        }
        .grid-cell .note-display {
            font-size: 1.5em;
        }
        .grid-cell.hidden {
            display: none;
        }

        /* Interaction button styles */
        .action-buttons-group, .modal-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
        }
        .action-buttons-group button, .modal-buttons button {
            flex: 1 1 auto;
            min-width: 120px;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            touch-action: manipulation;
        }

        .action-buttons-group button:disabled, .note-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .note-button.active, .toggle-button.active {
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(-1px);
            background-color: #3b82f6;
            color: white;
        }

        /* Note button styles */
        .note-building-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .natural-note-buttons, .accidental-buttons {
            display: grid;
            gap: 0.5rem;
        }
        .natural-note-buttons {
            grid-template-columns: repeat(auto-fit, minmax(3.5rem, 1fr));
        }
        .accidental-buttons {
            grid-template-columns: repeat(4, 1fr);
            max-width: 200px;
            margin: 0 auto;
        }
        .note-button {
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 600;
            background-color: #e2e8f0;
            border: 1px solid #cbd5e1;
            color: #475569;
            transition: all 0.2s;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.visible {
            display: flex;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        /* Feedback message styles */
        .feedback.correct {
            background-color: #dcfce7;
            color: #15803d;
            border: 1px solid #15803d;
        }
        .feedback.incorrect {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #b91c1c;
        }

        /* Piano styles */
        .piano-container {
            position: relative;
            display: flex;
            height: 200px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        .piano-key {
            border: 1px solid #64748b;
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        .piano-key.white {
            background-color: #ffffff;
            width: calc(100% / 22);
            height: 100%;
            border-radius: 0 0 5px 5px;
        }
        .piano-key.black {
            background-color: #334155;
            width: 3%;
            height: 65%;
            position: absolute;
            z-index: 2;
            transform: translateX(-50%);
            border-radius: 0 0 5px 5px;
        }
        /* Black key positions */
        .piano-key.black[data-note*="C#"] { left: calc(100% / 22 * 1); }
        .piano-key.black[data-note*="D#"] { left: calc(100% / 22 * 2); }
        .piano-key.black[data-note*="F#"] { left: calc(100% / 22 * 4); }
        .piano-key.black[data-note*="G#"] { left: calc(100% / 22 * 5); }
        .piano-key.black[data-note*="A#"] { left: calc(100% / 22 * 6); }
        .piano-key.black[data-note*="C#"][data-note*="/4"] { left: calc(100% / 22 * 8); }
        .piano-key.black[data-note*="D#"][data-note*="/4"] { left: calc(100% / 22 * 9); }
        .piano-key.black[data-note*="F#"][data-note*="/4"] { left: calc(100% / 22 * 11); }
        .piano-key.black[data-note*="G#"][data-note*="/4"] { left: calc(100% / 22 * 12); }
        .piano-key.black[data-note*="A#"][data-note*="/4"] { left: calc(100% / 22 * 13); }
        .piano-key.black[data-note*="C#"][data-note*="/5"] { left: calc(100% / 22 * 15); }
        .piano-key.black[data-note*="D#"][data-note*="/5"] { left: calc(100% / 22 * 16); }
        .piano-key.black[data-note*="F#"][data-note*="/5"] { left: calc(100% / 22 * 18); }
        .piano-key.black[data-note*="G#"][data-note*="/5"] { left: calc(100% / 22 * 19); }
        .piano-key.black[data-note*="A#"][data-note*="/5"] { left: calc(100% / 22 * 20); }
        
        .piano-key.white.selected {
            background-color: #93c5fd !important; /* Lighter blue for better contrast */
            border: 2px solid #3b82f6;
        }
         .piano-key.black.selected {
            background-color: #3b82f6 !important;
            border: 2px solid #93c5fd;
        }
        .piano-key.white.given-note-highlight {
            background-color: #fde047 !important;
            border: 2px solid #f59e0b;
        }
        .piano-key.black.given-note-highlight {
            background-color: #facc15 !important;
            border: 2px solid #fde047;
        }

        /* Tutorial Styles */
        #tutorialOverlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 2000;
        }
        #tutorialModal {
            position: absolute;
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 350px;
            width: 90%;
            border: 2px solid #3b82f6;
        }
        .tutorial-highlight {
            position: relative;
            z-index: 2001;
            box-shadow: 0 0 0 4px #3b82f6, 0 0 20px 10px rgba(59, 130, 246, 0.7);
            border-radius: 8px;
            transition: box-shadow 0.3s ease-in-out;
        }

        /* Tooltip style */
        [title]:hover::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(8px);
            background-color: #334155;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 10;
            transition-delay: 0.2s; /* Faster tooltip */
        }
        [title] {
            position: relative;
        }

        /* Responsive design for mobile devices */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                gap: 0.75rem;
                margin-top: 0.5rem;
            }
            #statusBar {
                flex-direction: column;
                gap: 0.5rem;
            }
            #statusBarInfo, #statusBarControls {
                width: 100%;
                justify-content: space-around;
            }
            #statusBarControls {
                flex-wrap: wrap;
            }
            #displaySection {
                flex-direction: column;
                align-items: center;
            }
            #chordQuestionText {
                font-size: 1rem;
            }
            #chordQuestionText strong {
                font-size: 1.1rem;
            }
            #questionArea {
                padding: 0.75rem;
            }
            .action-buttons-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
            }
            #confirmAnswerButton {
                grid-column: 1 / -1; /* Span full width */
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center">
    <!-- User selection modal -->
    <div id="welcomeModalOverlay" class="modal-overlay visible">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-lg w-11/12">
            <h2 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-4">Bienvenido a Bloque Arm√≥nico Pro</h2>
            <p class="text-lg text-gray-700 mb-6">Para continuar, selecciona tu perfil o crea uno nuevo.</p>
            <div class="mt-6 w-full max-w-sm mx-auto">
                <label for="userSelect" class="block text-sm font-medium text-gray-700 text-left">Selecciona tu Perfil</label>
                <div class="flex items-center gap-2">
                    <select id="userSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                    <button id="deleteUserButton" class="mt-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-2 rounded-md shadow-sm disabled:opacity-50" disabled title="Borrar Perfil Seleccionado">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                            <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
                        </svg>
                    </button>
                </div>
                <p class="text-center my-2 text-gray-500">o</p>
                <label for="newUserInput" class="block text-sm font-medium text-gray-700 text-left">Crea un Nuevo Perfil</label>
                <input type="text" id="newUserInput" placeholder="Escribe tu nombre aqu√≠" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
                <button id="loginButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors">Comenzar Sesi√≥n</button>
                <button id="guestLoginButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors">Entrar como Invitado</button>
            </div>
             <div class="text-center mt-8">
                <p class="text-sm text-gray-600">Una aplicaci√≥n de</p>
                <p class="text-lg font-bold text-blue-800 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-music-note-beamed" viewBox="0 0 16 16">
                      <path d="M6 13c0 1.105-1.12 2-2.5 2S1 14.105 1 13c0-1.104 1.12-2 2.5-2s2.5.896 2.5 2zm9-2c0 1.105-1.12 2-2.5 2s-2.5-.895-2.5-2 1.12-2 2.5-2 2.5.895 2.5 2z"/>
                      <path fill-rule="evenodd" d="M14 11V2h1v9h-1zM6 3v10H5V3h1z"/>
                      <path d="M5 2.905a1 1 0 0 1 .9-.995l8-.8a1 1 0 0 1 1.1.995V3L5 4V2.905z"/>
                    </svg>
                    Juan Miguel R√≠os Redondo
                </p>
            </div>
        </div>
    </div>
    
    <!-- Tutorial Prompt Modal -->
    <div id="tutorialPromptModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-blue-800 mb-4">¬°Hola, <span id="tutorialUserName"></span>!</h3>
            <p class="text-lg text-gray-700 mb-6">Parece que es tu primera vez. ¬øTe gustar√≠a ver un r√°pido tutorial?</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="promptStartTutorial" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors">S√≠, mostrar tutorial</button>
                <button id="promptSkipTutorial" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors">No, gracias</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-red-700 mb-4">Confirmar Eliminaci√≥n</h3>
            <p id="deleteConfirmText" class="text-gray-700 mb-6"></p>
            <div class="flex gap-4 justify-center">
                <button id="confirmDeleteButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">S√≠, Eliminar</button>
                <button id="cancelDeleteButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>


    <!-- Interactive Tutorial -->
    <div id="tutorialOverlay" class="hidden">
        <div id="tutorialModal">
            <h3 id="tutorialTitle" class="text-xl font-bold text-blue-800 mb-2"></h3>
            <p id="tutorialText" class="text-gray-700 mb-4"></p>
            <div class="flex flex-col gap-2 mt-4">
                <button id="tutorialNextButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Siguiente</button>
                <button id="tutorialEndButton" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Terminar Tutorial</button>
            </div>
        </div>
    </div>

    <!-- Main application container, hidden initially -->
    <div id="mainAppContainer" class="container hidden">
        <div class="flex flex-col items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-center">Bloque Arm√≥nico Pro</h1>
            <div id="chordQuestionWrapper" class="text-lg text-gray-700 mt-2">
                <p id="chordQuestionText">
                    <strong class="text-xl sm:text-2xl"></strong> es <strong class="text-xl sm:text-2xl"></strong> de un acorde <strong class="text-xl sm:text-2xl"></strong>.<br>
                    <small class="text-sm text-gray-500">Armoniza en bloque cerrado, <span class="font-bold text-indigo-700">4 voces</span>, descendente.</small>
                </p>
            </div>
        </div>

        <!-- Status bar (streak and score) -->
        <div id="statusBar" class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 p-2 bg-gray-50 rounded-lg gap-2">
            <div id="statusBarInfo" class="flex justify-around items-center gap-2 flex-grow">
                <div id="streakCounter" class="flex flex-col items-center p-2 rounded-xl bg-amber-50 border border-amber-200">
                    <div class="text-xs font-medium text-amber-600">üî• D√≠as de Racha</div>
                    <div class="text-xl font-bold text-amber-800">0</div>
                </div>
                <div id="userDisplay" class="flex flex-col items-center p-2 rounded-xl bg-indigo-50 border border-indigo-200">
                    <div class="text-xs font-medium text-indigo-600">üë§ Usuario</div>
                    <div id="currentUserName" class="text-base font-bold text-indigo-800"></div>
                </div>
                <div id="scoreCounter" class="flex flex-col items-center p-2 rounded-xl bg-gray-100 border border-gray-200">
                    <div class="text-sm text-green-600">‚úÖ 0</div>
                    <div class="text-sm text-red-600">‚ùå 0</div>
                </div>
            </div>
            <div id="statusBarControls" class="flex justify-center items-center gap-2 flex-wrap">
                <!-- Notation selector -->
                <div class="flex rounded-full bg-gray-200 p-1">
                    <input type="radio" id="notationAmericano" name="notationSystem" value="american" class="hidden" checked>
                    <label for="notationAmericano" class="py-1 px-3 text-xs font-semibold rounded-full cursor-pointer transition-colors hover:bg-white/50" title="Cifrado Americano (Anglosaj√≥n)">C,D,E</label>
                    <input type="radio" id="notationLatino" name="notationSystem" value="latin" class="hidden">
                    <label for="notationLatino" class="py-1 px-3 text-xs font-semibold rounded-full cursor-pointer transition-colors hover:bg-white/50" title="Cifrado Latino">Do,Re,Mi</label>
                </div>
                <button id="viewHistoryButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold w-10 h-10 flex items-center justify-center rounded-full shadow-sm transition-colors text-lg" title="Ver Historial de Sesi√≥n (V)">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-line-fill" viewBox="0 0 16 16">
                        <path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2z"/>
                    </svg>
                </button>
                <button id="switchUserButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold w-10 h-10 flex items-center justify-center rounded-full shadow-sm transition-colors text-lg" title="Cambiar de Usuario (U)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-people-fill" viewBox="0 0 16 16">
                        <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                        <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216zM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
                    </svg>
                </button>
                <button id="settingsButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold w-10 h-10 flex items-center justify-center rounded-full shadow-sm transition-colors text-lg" title="Ajustes de Pr√°ctica (S)">‚öôÔ∏è</button>
                <button id="showTutorialButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold w-10 h-10 flex items-center justify-center rounded-full shadow-sm transition-colors text-lg" title="Ver Tutorial (H)">?</button>
                <button id="fullscreenButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold w-10 h-10 flex items-center justify-center rounded-full shadow-sm transition-colors text-lg" title="Pantalla Completa (Q)">
                    <svg id="fullscreenIconOpen" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/>
                    </svg>
                    <svg id="fullscreenIconClose" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-fullscreen-exit hidden" viewBox="0 0 16 16">
                        <path d="M5.5 0a.5.5 0 0 1 .5.5v4A.5.5 0 0 1 5 5h-4a.5.5 0 0 1 0-1h3.5V.5a.5.5 0 0 1 .5-.5zm0 11a.5.5 0 0 1 .5.5v3.5h-3.5a.5.5 0 0 1 0-1h4v-3a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v3.5h3.5a.5.5 0 0 1 0 1h-4v-3a.5.5 0 0 1 .5-.5zm.5-11a.5.5 0 0 1 .5.5v3.5h3.5a.5.5 0 0 1 0 1h-4v-4a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Difficulty controls -->
        <div id="difficultySelection" class="flex flex-col items-center gap-2 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <label class="text-blue-800 font-semibold">Nivel de Dificultad:</label>
            <div class="flex gap-2 flex-wrap justify-center">
                <input type="radio" id="difficultyBasic" name="difficulty" value="basic" class="hidden" checked>
                <label for="difficultyBasic" class="difficulty-label py-2 px-4 rounded-full font-semibold text-sm cursor-pointer transition-colors duration-200">B√°sico</label>
                <input type="radio" id="difficultyIntermediate" name="difficulty" value="intermediate" class="hidden">
                <label for="difficultyIntermediate" class="difficulty-label py-2 px-4 rounded-full font-semibold text-sm cursor-pointer transition-colors duration-200">Intermedio</label>
                <input type="radio" id="difficultyAdvanced" name="difficulty" value="advanced" class="hidden">
                <label for="difficultyAdvanced" class="difficulty-label py-2 px-4 rounded-full font-semibold text-sm cursor-pointer transition-colors duration-200">Avanzado</label>
            </div>
        </div>
        
        <!-- Exercise display area -->
        <div id="displaySection" class="flex justify-center items-start gap-4">
            <div id="questionArea" class="w-full max-w-md md:flex-1 md:min-w-[250px] p-4 bg-blue-100 rounded-lg border border-blue-300">
                <p class="text-lg font-bold text-blue-800 mb-2">Construye el acorde:</p>
                <div class="notes-grid w-full">
                    <div class="grid-cell" id="gridCell0">
                        <span class="interval-label text-gray-500"></span>
                        <span class="note-display font-bold"></span>
                    </div>
                    <div class="grid-cell" id="gridCell1">
                        <span class="interval-label text-gray-500"></span>
                        <span class="note-display font-bold"></span>
                    </div>
                    <div class="grid-cell" id="gridCell2">
                        <span class="interval-label text-gray-500"></span>
                        <span class="note-display font-bold"></span>
                    </div>
                    <div class="grid-cell" id="gridCell3">
                        <span class="interval-label text-gray-500"></span>
                        <span class="note-display font-bold"></span>
                    </div>
                </div>
            </div>
            <div id="staffArea" class="w-full max-w-md md:flex-1 md:min-w-[300px] flex justify-center items-center">
                <canvas id="musicalStaffCanvas"></canvas>
            </div>
        </div>
        
        <!-- Note input options (Cifrado vs Piano) -->
        <div id="inputMethodToggle" class="flex justify-center mb-4">
            <div class="flex p-1 bg-gray-200 rounded-full" title="Cambiar Entrada (I)">
                <button id="cifradoToggle" class="py-2 px-4 rounded-full font-semibold transition-all bg-white text-blue-600 shadow-sm active">Cifrado</button>
                <button id="pianoToggle" class="py-2 px-4 rounded-full font-semibold transition-all text-gray-700">Piano</button>
            </div>
        </div>

        <!-- Note selection controls (Cifrado) -->
        <div id="noteBuildingControls" class="flex flex-col gap-4">
            <div id="naturalNoteButtons" class="natural-note-buttons"></div>
            <div id="accidentalButtons" class="accidental-buttons"></div>
        </div>

        <!-- Piano keyboard, initially hidden -->
        <div id="piano-container" class="piano-container hidden"></div>

        <!-- Main action buttons -->
        <div class="action-buttons-group mt-4">
            <button id="confirmAnswerButton" class="bg-green-600 hover:bg-green-700 text-white disabled:opacity-50" title="Confirmar (Enter)">Confirmar</button>
            <button id="hintButton" class="bg-yellow-500 hover:bg-yellow-600 text-white disabled:opacity-50" title="Pista (P)">Pista</button>
            <button id="showAnswerButton" class="bg-red-600 hover:bg-red-700 text-white disabled:opacity-50" title="Mostrar Respuesta (R)">Mostrar Respuesta</button>
            <button id="clearAllSelectionButton" class="bg-gray-400 hover:bg-gray-500 text-white disabled:opacity-50" title="Borrar (N)">Borrar</button>
            <button id="changeQuestionButton" class="bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50" title="Cambiar Ejercicio (Espacio)">Cambiar Ejercicio</button>
        </div>
    </div>
    
    <!-- Modal for instant feedback -->
    <div id="quickFeedbackModalOverlay" class="modal-overlay hidden">
        <div id="quickFeedbackModalContent" class="modal-content feedback p-6 rounded-xl shadow-lg"></div>
    </div>
    
    <!-- Modal for Hint -->
    <div id="hintModalOverlay" class="modal-overlay hidden">
        <div class="modal-content p-6 rounded-xl shadow-lg bg-yellow-50 border-yellow-300 border">
            <h3 id="hintModalTitle" class="text-2xl font-bold text-yellow-800 text-center mb-4">Pista</h3>
            <div id="hintModalBody" class="text-yellow-900 mb-6"></div>
            <div class="flex justify-center">
                <button id="hintModalCloseButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Modal for Answer -->
    <div id="infoModalOverlay" class="modal-overlay hidden">
        <div class="modal-content p-6 rounded-xl shadow-lg">
            <h3 id="infoModalTitle" class="text-2xl font-bold text-blue-800 text-center mb-4"></h3>
            <div id="infoModalBody" class="text-gray-700 mb-6 text-left"></div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="infoModalCloseButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal for session evaluation -->
    <div id="evaluationModalOverlay" class="modal-overlay hidden">
        <div id="evaluationModalContent" class="modal-content p-6 rounded-xl shadow-lg text-left">
            <h3 class="text-2xl font-bold text-blue-800 text-center mb-4">Resultados de la Evaluaci√≥n</h3>
            <p id="evaluationSummary" class="text-gray-700 mb-2"></p>
            <p class="text-lg font-bold text-gray-800 mt-4 mb-2">√Åreas a trabajar:</p>
            <ul id="adviceList" class="list-disc list-inside text-gray-600 space-y-1"></ul>
            <div class="flex justify-center gap-4 mt-6">
                <button id="continueTrainingButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Continuar Entrenamiento</button>
                <button id="endSessionButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Terminar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <!-- Modal for practice settings -->
    <div id="settingsModalOverlay" class="modal-overlay hidden">
        <div id="settingsModalContent" class="modal-content p-6 rounded-xl shadow-lg text-left">
            <h3 class="text-2xl font-bold text-blue-800 text-center mb-4">Ajustes de Pr√°ctica</h3>
            <div class="mb-4">
                <h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-2">Tipos de Acorde</h4>
                <div id="chordTypesCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
            </div>
            <div id="leadVoicesSection" class="mb-4 hidden">
                <h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-2">Voces Principales (Tensiones)</h4>
                <div id="leadVoicesCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="saveSettingsButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Guardar y Reiniciar</button>
                <button id="cancelSettingsButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal for enharmonic selection -->
    <div id="enharmonicModalOverlay" class="modal-overlay hidden">
        <div id="enharmonicModalContent" class="modal-content p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-bold text-blue-800 mb-2">Seleccionar Alteraci√≥n</h3>
            <p class="text-gray-700 mb-4">¬øC√≥mo deseas escribir esta nota?</p>
            <div id="enharmonicChoices" class="flex justify-center gap-4"></div>
        </div>
    </div>

    <!-- Session History Modal -->
    <div id="historyModalOverlay" class="modal-overlay hidden">
        <div class="container p-6 text-center overflow-y-auto max-h-[90vh]">
            <h2 id="historyModalTitle" class="text-3xl font-bold text-blue-800 mb-4"></h2>
            <div id="historyModalContent" class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <!-- Content will be populated by JS -->
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="closeHistoryModalButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Volver a la Pr√°ctica</button>
            </div>
        </div>
    </div>


    <!-- Final message and session statistics -->
    <div id="finalMessageDisplay" class="container hidden p-6 text-center">
        <!-- Content structure identical to history modal, will be populated by JS -->
        <h2 class="text-3xl font-bold text-blue-800 mb-4">¬°Sesi√≥n Terminada!</h2>
        <div id="resultsContentToCapture" class="bg-gray-50 p-6 rounded-lg border border-gray-200">
             <!-- Content populated by JS -->
        </div>
        <div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
            <button id="switchUserFinalButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Cambiar de Usuario</button>
            <button id="saveAsPhotoButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Guardar como Foto (PNG)</button>
            <button id="saveAsPdfButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar como PDF</button>
        </div>
    </div>

    <!-- Main application script -->
    <script type="module">
        // Import VexFlow modules for the staff
        import { Renderer, Stave, StaveNote, Voice, Formatter, Accidental } from "https://cdn.jsdelivr.net/npm/vexflow/build/esm/vexflow.js";

        // Central application state
        const state = {
            currentUser: null,
            correctNotes: [],
            correctNotesWithOctave: [],
            chordRoot: '',
            chordTypeKey: '',
            givenIntervalName: '',
            givenLabel: '',
            givenNote: '',
            givenNoteWithOctave: '',
            orderedLabelsForDisplay: [],
            selectedUserNotes: [],
            stats: {},
            evaluation: {
                questionsAttemptedInBatch: 0,
                exercisesPerEval: 5,
            },
            currentExerciseId: null,
            failedCurrentExercise: false,
            answerWasShown: false,
            difficulty: 'basic',
            notationSystem: 'american',
            customPractice: {
                basic: { isActive: false, allowedChords: [] },
                intermediate: { isActive: false, allowedChords: [] },
                advanced: { isActive: false, allowedChords: [], allowedLeads: [] }
            },
            audioContextStarted: false,
            session: {
                startTime: 0
            },
            tutorial: {
                currentStep: 0,
                isActive: false
            },
            keyboard: {
                lastAccidentalKey: null,
                lastAccidentalTimestamp: 0,
                doublePressThreshold: 400 // ms
            }
        };

        // Chart instance variable
        let historyChart = null;
        let historyModalChart = null;

        // Constants for musical logic
        const noteToSemitoneMap = {
            'C': 0, 'B#': 0,
            'C#': 1, 'Db': 1,
            'D': 2,
            'D#': 3, 'Eb': 3,
            'E': 4, 'Fb': 4,
            'F': 5, 'E#': 5,
            'F#': 6, 'Gb': 6,
            'G': 7,
            'G#': 8, 'Ab': 8,
            'A': 9,
            'A#': 10, 'Bb': 10,
            'B': 11, 'Cb': 11,
            'Cbb': 10, 'B##': 1,
            'Dbb': 0, 'C##': 2,
            'Ebb': 2, 'D##': 4,
            'Fbb': 3, 'E##': 6,
            'Gbb': 5, 'F##': 7,
            'Abb': 7, 'G##': 9,
            'Bbb': 9, 'A##': 11,
        };
        const naturalLetterSemitone = { 'C': 0, 'D': 2, 'E': 4, 'F': 5, 'G': 7, 'A': 9, 'B': 11 };
        const numberToLetterMap = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const letterToNumberMap = { 'C': 0, 'D': 1, 'E': 2, 'F': 3, 'G': 4, 'A': 5, 'B': 6 };
        const naturalNotes = ["C", "D", "E", "F", "G", "A", "B"];
        const accidentals = ["#", "b", "##", "bb"];
        const enharmonicEquivalents = { "C#": "Db", "D#": "Eb", "F#": "Gb", "G#": "Ab", "A#": "Bb", "Db": "C#", "Eb": "D#", "Gb": "F#", "Ab": "G#", "Bb": "A#" };
        const americanToLatin = { "C": "Do", "D": "Re", "E": "Mi", "F": "Fa", "G": "Sol", "A": "La", "B": "Si" };

        const chordStructures = {
            "major": { name: "Mayor", cifrado: "", difficulty: "basic", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 4, name: "tercera mayor", label: "3", degreeOffset: 2 }, { semitones: 7, name: "quinta justa", label: "5", degreeOffset: 4 }], voicing_rules: { "1": ["1", "5", "3", "1"], "3": ["3", "1", "5", "3"], "5": ["5", "3", "1", "5"] } },
            "minor": { name: "Menor", cifrado: "m", difficulty: "basic", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 3, name: "tercera menor", label: "b3", degreeOffset: 2 }, { semitones: 7, name: "quinta justa", label: "5", degreeOffset: 4 }], voicing_rules: { "1": ["1", "5", "b3", "1"], "b3": ["b3", "1", "5", "b3"], "5": ["5", "b3", "1", "5"] } },
            "augmented": { name: "Aumentado", cifrado: "aug", difficulty: "basic", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 4, name: "tercera mayor", label: "3", degreeOffset: 2 }, { semitones: 8, name: "quinta aumentada", label: "#5", degreeOffset: 4 }], voicing_rules: { "1": ["1", "#5", "3", "1"], "3": ["3", "1", "#5", "3"], "#5": ["#5", "3", "1", "#5"] } },
            "diminished": { name: "Disminuido", cifrado: "¬∫", difficulty: "basic", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 3, name: "tercera menor", label: "b3", degreeOffset: 2 }, { semitones: 6, name: "quinta disminuida", label: "b5", degreeOffset: 4 }], voicing_rules: { "1": ["1", "b5", "b3", "1"], "b3": ["b3", "1", "b5", "b3"], "b5": ["b5", "b3", "1", "1"] } },
            "sus2": { name: "Sus2", cifrado: "sus2", difficulty: "basic", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 2, name: "segunda mayor", label: "2", degreeOffset: 1 }, { semitones: 7, name: "quinta justa", label: "5", degreeOffset: 4 }], voicing_rules: { "1": ["1", "5", "2", "1"], "2": ["2", "1", "5", "2"], "5": ["5", "2", "1", "5"] } },
            "sus4": { name: "Sus4", cifrado: "sus4", difficulty: "basic", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 5, name: "cuarta justa", label: "4", degreeOffset: 3 }, { semitones: 7, name: "quinta justa", label: "5", degreeOffset: 4 }], voicing_rules: { "1": ["1", "5", "4", "1"], "4": ["4", "1", "5", "4"], "5": ["5", "4", "1", "5"] } },
            "maj7": { name: "Mayor 7", cifrado: "maj7", difficulty: "intermediate", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 4, name: "tercera mayor", label: "3", degreeOffset: 2 }, { semitones: 7, name: "quinta justa", label: "5", degreeOffset: 4 }, { semitones: 11, name: "s√©ptima mayor", label: "7", degreeOffset: 6 }, { semitones: 2, name: "novena mayor", label: "9", degreeOffset: 1 }, { semitones: 6, name: "onceava aumentada", label: "#11", degreeOffset: 3 }], voicing_rules: { "1": ["1", "7", "5", "3"], "3": ["3", "1", "7", "5"], "5": ["5", "3", "1", "7"], "7": ["7", "5", "3", "1"], "9": ["9", "7", "5", "3"], "#11": ["#11", "3", "1", "7"] } },
            "m7": { name: "Menor 7", cifrado: "m7", difficulty: "intermediate", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 3, name: "tercera menor", label: "b3", degreeOffset: 2 }, { semitones: 7, name: "quinta justa", "label": "5", degreeOffset: 4 }, { semitones: 10, name: "s√©ptima menor", label: "b7", degreeOffset: 6 }, { semitones: 2, name: "novena mayor", label: "9", degreeOffset: 1 }, { semitones: 5, name: "onceava justa", label: "11", degreeOffset: 3 }], voicing_rules: { "1": ["1", "b7", "5", "b3"], "b3": ["b3", "1", "b7", "5"], "5": ["5", "b3", "1", "b7"], "b7": ["b7", "5", "b3", "1"], "9": ["9", "b7", "5", "b3"], "11": ["11", "b3", "1", "b7"] } },
            "7": { name: "7 (Dominante)", cifrado: "7", difficulty: "intermediate", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 4, name: "tercera mayor", label: "3", degreeOffset: 2 }, { semitones: 7, name: "quinta justa", label: "5", degreeOffset: 4 }, { semitones: 10, name: "s√©ptima menor", label: "b7", degreeOffset: 6 }, { semitones: 2, name: "novena mayor", label: "9", degreeOffset: 1 }, { semitones: 1, name: "novena menor", label: "b9", degreeOffset: 1 }, { semitones: 3, name: "novena aumentada", label: "#9", degreeOffset: 1 }, { semitones: 6, name: "onceava aumentada", label: "#11", degreeOffset: 3 }, { semitones: 9, name: "trecena mayor", label: "13", degreeOffset: 5 }, { semitones: 8, name: "trecena menor", label: "b13", degreeOffset: 5 }, { semitones: 5, name: "onceava justa", label: "11", degreeOffset: 3 }], voicing_rules: { "1": ["1", "b7", "5", "3"], "3": ["3", "1", "b7", "5"], "5": ["5", "3", "1", "b7"], "b7": ["b7", "5", "3", "1"], "9": ["9", "b7", "5", "3"], "b9": ["b9", "b7", "5", "3"], "#9": ["#9", "b7", "5", "3"], "11": ["11", "1", "b7", "5"], "#11": ["#11", "3", "1", "b7"], "13": ["13", "3", "1", "b7"], "b13": ["b13", "3", "1", "b7"] } },
            "m7b5": { name: "Menor 7(b5)", cifrado: "m7(b5)", difficulty: "intermediate", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 3, name: "tercera menor", label: "b3", degreeOffset: 2 }, { semitones: 6, name: "quinta disminuida", label: "b5", degreeOffset: 4 }, { semitones: 10, name: "s√©ptima menor", label: "b7", degreeOffset: 6 }, { semitones: 5, name: "onceava justa", label: "11", degreeOffset: 3 }, { semitones: 1, name: "novena menor", label: "b9", degreeOffset: 1 }], voicing_rules: { "1": ["1", "b7", "b5", "b3"], "b3": ["b3", "1", "b7", "b5"], "b5": ["b5", "b3", "1", "b7"], "b7": ["b7", "b5", "b3", "1"], "b9": ["b9", "b7", "b5", "b3"], "11": ["11", "b3", "b7", "b5"] } },
            "dim7": { name: "Disminuido 7", cifrado: "¬∫7", difficulty: "intermediate", intervals: [{ semitones: 0, name: "fundamental", label: "1", degreeOffset: 0 }, { semitones: 3, name: "tercera menor", label: "b3", degreeOffset: 2 }, { semitones: 6, name: "quinta disminuida", label: "b5", degreeOffset: 4 }, { semitones: 9, name: "s√©ptima disminuida", label: "bb7", degreeOffset: 6 }], voicing_rules: { "1": ["1", "bb7", "b5", "b3"], "b3": ["b3", "1", "bb7", "b5"], "b5": ["b5", "b3", "1", "bb7"], "bb7": ["bb7", "b5", "b3", "1"] } }
        };

        // DOM element references
        let welcomeModalOverlay, mainAppContainer, chordQuestionText, gridCells, noteBuildingControls, naturalNoteButtonsContainer, 
            accidentalButtonsContainer, musicalStaffCanvas, confirmAnswerButton, clearAllSelectionButton, changeQuestionButton, 
            hintButton, showAnswerButton, quickFeedbackModalOverlay, quickFeedbackModalContent, evaluationModalOverlay, 
            evaluationSummary, adviceList, continueTrainingButton, endSessionButton, finalMessageDisplay, resultsContentToCapture, 
            difficultyRadios, streakCounter, scoreCounter, settingsButton, settingsModalOverlay, saveSettingsButton, 
            cancelSettingsButton, chordTypesCheckboxesContainer, leadVoicesCheckboxesContainer, leadVoicesSection, cifradoToggle, 
            pianoToggle, pianoContainer, enharmonicModalOverlay, enharmonicChoicesContainer, notationRadios, infoModalOverlay, 
            infoModalTitle, infoModalBody, infoModalCloseButton, hintModalOverlay, hintModalBody, hintModalCloseButton, 
            showTutorialButton, fullscreenButton, fullscreenIconOpen, fullscreenIconClose, tutorialEndButton, userSelect, 
            newUserInput, loginButton, guestLoginButton, deleteUserButton, currentUserName, switchUserButton, 
            switchUserFinalButton, tutorialPromptModalOverlay, tutorialUserName, promptStartTutorial, promptSkipTutorial, 
            deleteConfirmModalOverlay, deleteConfirmText, confirmDeleteButton, cancelDeleteButton, viewHistoryButton, 
            historyModalOverlay, historyModalTitle, historyModalContent, closeHistoryModalButton;
        
        let synth, reverb;

        function assignDomElements() {
            welcomeModalOverlay = document.getElementById('welcomeModalOverlay');
            mainAppContainer = document.getElementById('mainAppContainer');
            chordQuestionText = document.getElementById('chordQuestionText');
            gridCells = [
                document.getElementById('gridCell0'), document.getElementById('gridCell1'),
                document.getElementById('gridCell2'), document.getElementById('gridCell3')
            ];
            noteBuildingControls = document.getElementById('noteBuildingControls');
            naturalNoteButtonsContainer = document.getElementById('naturalNoteButtons');
            accidentalButtonsContainer = document.getElementById('accidentalButtons');
            musicalStaffCanvas = document.getElementById('musicalStaffCanvas');
            confirmAnswerButton = document.getElementById('confirmAnswerButton');
            clearAllSelectionButton = document.getElementById('clearAllSelectionButton');
            changeQuestionButton = document.getElementById('changeQuestionButton');
            hintButton = document.getElementById('hintButton');
            showAnswerButton = document.getElementById('showAnswerButton');
            quickFeedbackModalOverlay = document.getElementById('quickFeedbackModalOverlay');
            quickFeedbackModalContent = document.getElementById('quickFeedbackModalContent');
            evaluationModalOverlay = document.getElementById('evaluationModalOverlay');
            evaluationSummary = document.getElementById('evaluationSummary');
            adviceList = document.getElementById('adviceList');
            continueTrainingButton = document.getElementById('continueTrainingButton');
            endSessionButton = document.getElementById('endSessionButton');
            finalMessageDisplay = document.getElementById('finalMessageDisplay');
            resultsContentToCapture = document.getElementById('resultsContentToCapture');
            difficultyRadios = document.querySelectorAll('input[name="difficulty"]');
            streakCounter = document.getElementById('streakCounter').querySelector('.text-xl');
            scoreCounter = document.getElementById('scoreCounter');
            settingsButton = document.getElementById('settingsButton');
            settingsModalOverlay = document.getElementById('settingsModalOverlay');
            saveSettingsButton = document.getElementById('saveSettingsButton');
            cancelSettingsButton = document.getElementById('cancelSettingsButton');
            chordTypesCheckboxesContainer = document.getElementById('chordTypesCheckboxes');
            leadVoicesCheckboxesContainer = document.getElementById('leadVoicesCheckboxes');
            leadVoicesSection = document.getElementById('leadVoicesSection');
            cifradoToggle = document.getElementById('cifradoToggle');
            pianoToggle = document.getElementById('pianoToggle');
            pianoContainer = document.getElementById('piano-container');
            enharmonicModalOverlay = document.getElementById('enharmonicModalOverlay');
            enharmonicChoicesContainer = document.getElementById('enharmonicChoices');
            notationRadios = document.querySelectorAll('input[name="notationSystem"]');
            infoModalOverlay = document.getElementById('infoModalOverlay');
            infoModalTitle = document.getElementById('infoModalTitle');
            infoModalBody = document.getElementById('infoModalBody');
            infoModalCloseButton = document.getElementById('infoModalCloseButton');
            hintModalOverlay = document.getElementById('hintModalOverlay');
            hintModalBody = document.getElementById('hintModalBody');
            hintModalCloseButton = document.getElementById('hintModalCloseButton');
            showTutorialButton = document.getElementById('showTutorialButton');
            fullscreenButton = document.getElementById('fullscreenButton');
            fullscreenIconOpen = document.getElementById('fullscreenIconOpen');
            fullscreenIconClose = document.getElementById('fullscreenIconClose');
            tutorialEndButton = document.getElementById('tutorialEndButton');
            userSelect = document.getElementById('userSelect');
            newUserInput = document.getElementById('newUserInput');
            loginButton = document.getElementById('loginButton');
            guestLoginButton = document.getElementById('guestLoginButton');
            deleteUserButton = document.getElementById('deleteUserButton');
            currentUserName = document.getElementById('currentUserName');
            switchUserButton = document.getElementById('switchUserButton');
            switchUserFinalButton = document.getElementById('switchUserFinalButton');
            tutorialPromptModalOverlay = document.getElementById('tutorialPromptModalOverlay');
            tutorialUserName = document.getElementById('tutorialUserName');
            promptStartTutorial = document.getElementById('promptStartTutorial');
            promptSkipTutorial = document.getElementById('promptSkipTutorial');
            deleteConfirmModalOverlay = document.getElementById('deleteConfirmModalOverlay');
            deleteConfirmText = document.getElementById('deleteConfirmText');
            confirmDeleteButton = document.getElementById('confirmDeleteButton');
            cancelDeleteButton = document.getElementById('cancelDeleteButton');
            viewHistoryButton = document.getElementById('viewHistoryButton');
            historyModalOverlay = document.getElementById('historyModalOverlay');
            historyModalTitle = document.getElementById('historyModalTitle');
            historyModalContent = document.getElementById('historyModalContent');
            closeHistoryModalButton = document.getElementById('closeHistoryModalButton');
        }

        // --- Main Logic ---

        /**
         * Initializes the audio context and the application.
         */
        async function initializeApp(startWithTutorial) {
            tutorialPromptModalOverlay.classList.remove('visible');
            mainAppContainer.classList.remove('hidden');
            
            if (state.session.startTime === 0) {
                 state.session.startTime = Date.now();
            }

            try {
                if (!state.audioContextStarted) {
                    await Tone.start();
                    synth = new Tone.PolySynth(Tone.FMSynth, {
                        oscillator: { type: "sine" },
                        envelope: { attack: 0.005, decay: 0.8, sustain: 0.0, release: 1.0 },
                        modulation: { type: "sine" },
                        modulationEnvelope: { attack: 0.001, decay: 0.2, sustain: 0.0, release: 0.2 },
                        harmonicity: 3, modulationIndex: 15
                    }).toDestination();
                    reverb = new Tone.Reverb({ decay: 1.5, preDelay: 0.01, wet: 0.3 }).toDestination();
                    synth.connect(reverb);
                    state.audioContextStarted = true;
                }
            } catch (e) {
                console.error("Error initializing audio:", e);
                showCustomMessage("Error de Audio", "No se pudo iniciar el audio.", "error");
            }
            
            updateDifficultySelectionUI(); // Set initial button colors
            generateNoteButtons();
            generatePiano();
            // Listeners for main app are added here, only once per session
            addEventListeners();
            updateStatsDisplay();
            generateExercise();

            if (startWithTutorial) {
                startTutorial();
            }
        }
        
        function updateDifficultySelectionUI() {
            difficultyRadios.forEach(radio => {
                const label = document.querySelector(`label[for="${radio.id}"]`);
                if (label) {
                    if (radio.checked) {
                        label.classList.add('bg-green-500', 'text-white', 'shadow-md');
                        label.classList.remove('bg-gray-300', 'text-gray-900');
                    } else {
                        label.classList.add('bg-gray-300', 'text-gray-900');
                        label.classList.remove('bg-green-500', 'text-white', 'shadow-md');
                    }
                }
            });
        }
        
        let mainAppListenersAttached = false;
        function addEventListeners() {
            if(mainAppListenersAttached) return;

            confirmAnswerButton.addEventListener('click', checkAnswer);
            clearAllSelectionButton.addEventListener('click', clearSelection);
            changeQuestionButton.addEventListener('click', () => {
                completeExercise('skipped');
                generateExercise();
            });
            hintButton.addEventListener('click', giveHint);
            showAnswerButton.addEventListener('click', showAnswer);
            showTutorialButton.addEventListener('click', startTutorial);
            tutorialEndButton.addEventListener('click', endTutorial);
            document.addEventListener('keydown', handleKeyPress);
            fullscreenButton.addEventListener('click', toggleFullscreen);
            document.addEventListener('fullscreenchange', updateFullscreenIcons);
            document.addEventListener('webkitfullscreenchange', updateFullscreenIcons);
            
            difficultyRadios.forEach(radio => radio.addEventListener('change', (event) => {
                state.difficulty = event.target.value;
                updateDifficultySelectionUI();
                generateExercise();
            }));

            settingsButton.addEventListener('click', openSettingsModal);
            saveSettingsButton.addEventListener('click', saveSettings);
            cancelSettingsButton.addEventListener('click', closeSettingsModal);

            cifradoToggle.addEventListener('click', () => {
                noteBuildingControls.classList.remove('hidden');
                pianoContainer.classList.add('hidden');
                cifradoToggle.classList.add('bg-white', 'text-blue-600', 'shadow-sm', 'active');
                pianoToggle.classList.remove('bg-white', 'text-blue-600', 'shadow-sm', 'active');
                updateDisplay();
            });

            pianoToggle.addEventListener('click', () => {
                noteBuildingControls.classList.add('hidden');
                pianoContainer.classList.remove('hidden');
                pianoToggle.classList.add('bg-white', 'text-blue-600', 'shadow-sm', 'active');
                cifradoToggle.classList.remove('bg-white', 'text-blue-600', 'shadow-sm', 'active');
                updateDisplay();
            });

            pianoContainer.addEventListener('click', handlePianoKeyClick);

            notationRadios.forEach(radio => radio.addEventListener('change', (event) => {
                state.notationSystem = event.target.value;
                updateDisplay();
                generateNoteButtons();
            }));

            continueTrainingButton.addEventListener('click', () => evaluationModalOverlay.classList.remove('visible'));
            endSessionButton.addEventListener('click', endSession);
            saveAsPhotoButton.addEventListener('click', saveAsPhoto);
            saveAsPdfButton.addEventListener('click', saveAsPdf);
            window.addEventListener('resize', () => drawMusicalStaff(state.selectedUserNotes));
            
            infoModalCloseButton.addEventListener('click', () => {
                infoModalOverlay.classList.remove('visible');
                if (state.answerWasShown) {
                    hintButton.disabled = true;
                    showAnswerButton.disabled = true;
                }
            });
            
            hintModalCloseButton.addEventListener('click', () => {
                hintModalOverlay.classList.remove('visible');
            });

            switchUserButton.addEventListener('click', handleSwitchUser);
            switchUserFinalButton.addEventListener('click', handleSwitchUser);

            viewHistoryButton.addEventListener('click', showHistoryModal);
            closeHistoryModalButton.addEventListener('click', () => historyModalOverlay.classList.remove('visible'));

            deleteUserButton.addEventListener('click', confirmDeleteUser);
            cancelDeleteButton.addEventListener('click', () => deleteConfirmModalOverlay.classList.remove('visible'));
            
            mainAppListenersAttached = true;
        }

        function showCustomMessage(title, message, type = 'info') {
            const modal = document.createElement('div');
            modal.className = `modal-overlay visible`;
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-xl shadow-lg feedback ${type === 'success' ? 'correct' : (type === 'error' ? 'incorrect' : '')}">
                    <h3 class="text-xl font-bold mb-2">${title}</h3>
                    <p>${message}</p>
                </div>`;
            document.body.appendChild(modal);
            setTimeout(() => modal.remove(), 2500);
        }
        
        function getNoteSemitone(noteName) {
            const naturalPartMatch = noteName.match(/[A-G]/i);
            if (!naturalPartMatch) return null;
            const naturalPart = naturalPartMatch[0].toUpperCase();
            const accidentalPart = noteName.substring(naturalPart.length);

            let semitone = naturalLetterSemitone[naturalPart];
            for (const char of accidentalPart) {
                if (char === '#') semitone++;
                else if (char === 'b') semitone--;
            }
            return (semitone % 12 + 12) % 12;
        }

        function displayNote(americanNote) {
            if (!americanNote) return "?";
            const naturalPart = americanNote.match(/[A-G]/i);
            if (!naturalPart) return americanNote;
            
            const accidentalPart = americanNote.substring(naturalPart[0].length);
            
            if (state.notationSystem === 'latin') {
                const latinPart = americanToLatin[naturalPart[0].toUpperCase()];
                return latinPart + accidentalPart;
            }
            return americanNote;
        }
        
        function updateQuestionText() {
            if (state.givenNote && state.givenIntervalName) {
                const noteDisplay = displayNote(state.givenNote);
                const rootDisplay = displayNote(state.chordRoot);
                const chordCifrado = chordStructures[state.chordTypeKey].cifrado;
                const chordFullName = `${rootDisplay}${chordCifrado}`;

                chordQuestionText.innerHTML = `<strong class="text-xl sm:text-2xl">${noteDisplay}</strong> es <strong class="text-xl sm:text-2xl">${state.givenIntervalName} (${state.givenLabel})</strong> del acorde de <strong class="text-xl sm:text-2xl">${chordFullName}</strong>.<br>
                <small class="text-sm text-gray-500">Armoniza en bloque cerrado descendente (${noteDisplay} es la nota mas aguda).</small>`;
            }
        }

        function drawMusicalStaff(notesWithOctave = []) {
            const canvas = musicalStaffCanvas;
            const context = canvas.getContext('2d');
            
            const fixedWidth = 300; 
            const fixedHeight = 150;
            canvas.width = fixedWidth;
            canvas.height = fixedHeight;
            
            context.clearRect(0, 0, canvas.width, canvas.height);

            const renderer = new Renderer(canvas, Renderer.Backends.CANVAS);
            renderer.resize(canvas.width, canvas.height);
            const ctx = renderer.getContext();
            
            const stave = new Stave(10, 0, fixedWidth - 20); 
            stave.addClef("treble").setContext(ctx).draw();

            if (notesWithOctave.length === 0) return;
            const validNotes = notesWithOctave.filter(note => note && note.includes('/'));
            if (validNotes.length === 0) return;

            const sortedNotes = [...validNotes].sort((a, b) => Tone.Midi(a.replace('/', '')).toMidi() - Tone.Midi(b.replace('/', '')).toMidi());
            
            const staveNotes = [];
            sortedNotes.forEach(note => {
                const noteName = note.split('/')[0];
                const vexNote = noteName.replace('bb', 'bb').replace('##', '##') + "/" + note.split('/')[1];
                staveNotes.push(vexNote);
            });

            const chordStaveNote = new StaveNote({ keys: staveNotes, duration: "w" });
            
            sortedNotes.forEach((note, index) => {
                const noteName = note.split('/')[0];
                const accidentalPart = noteName.match(/[#b]+/);
                if (accidentalPart) {
                    chordStaveNote.addAccidental(index, new Accidental(accidentalPart[0]));
                }
            });

            const voice = new Voice({ num_beats: 4, beat_value: 4 });
            voice.addTickables([chordStaveNote]);
            new Formatter().joinVoices([voice]).format([voice], canvas.width - 40);
            voice.draw(ctx, stave);
        }

        function calculateNoteName(rootNote, interval) {
            const rootLetter = rootNote.charAt(0);
            const rootLetterNum = letterToNumberMap[rootLetter];
            const rootSemitone = getNoteSemitone(rootNote);

            const targetLetterNum = (rootLetterNum + interval.degreeOffset) % 7;
            const targetLetter = numberToLetterMap[targetLetterNum];
            
            const targetNaturalSemitone = naturalLetterSemitone[targetLetter];
            const targetTotalSemitone = (rootSemitone + interval.semitones) % 12;

            let diff = targetTotalSemitone - targetNaturalSemitone;
            if (diff > 6) diff -= 12;
            if (diff < -6) diff += 12;

            const accidentalMap = { 2: "##", 1: "#", 0: "", "-1": "b", "-2": "bb" };
            const accidental = accidentalMap[diff] || '';
            
            return targetLetter + accidental;
        }


        function generateExercise() {
            state.failedCurrentExercise = false;
            state.answerWasShown = false;
            
            const currentPracticeSettings = state.customPractice[state.difficulty];

            const chords = Object.keys(chordStructures).filter(key => {
                const chord = chordStructures[key];
                const isBasic = state.difficulty === 'basic' && chord.difficulty === 'basic';
                const isIntermediate = state.difficulty === 'intermediate' && chord.difficulty === 'intermediate';
                const isAdvanced = state.difficulty === 'advanced' && chord.difficulty === 'intermediate';
                const matchesDifficulty = isBasic || isIntermediate || isAdvanced;
                
                const matchesCustom = !currentPracticeSettings.isActive || currentPracticeSettings.allowedChords.includes(key);

                return matchesDifficulty && matchesCustom;
            });

            if (chords.length === 0) {
                showCustomMessage("Sin Acordes", "No hay acordes disponibles. Revisa tus ajustes (S).", "warning");
                return;
            }
            const chordTypeKey = chords[Math.floor(Math.random() * chords.length)];
            const chordData = chordStructures[chordTypeKey];
            
            const leads = Object.keys(chordData.voicing_rules).filter(label => {
                const allTensions = ['b9', '9', '#9', '11', '#11', 'b13', '13'];
                const isTension = allTensions.includes(label);

                const difficultyMatch = (state.difficulty === 'advanced') ? isTension : !isTension;
                if (!difficultyMatch) return false;

                if (state.difficulty === 'advanced' && currentPracticeSettings.isActive && currentPracticeSettings.allowedLeads.length > 0) {
                    return currentPracticeSettings.allowedLeads.includes(label);
                }
                return true;
            });

            if (leads.length === 0) {
                 generateExercise();
                 return;
            }
            const givenLabel = leads[Math.floor(Math.random() * leads.length)];
            
            const possibleRoots = ["C", "F", "G", "Bb", "Eb", "Ab", "Db", "Gb", "D", "A", "E", "B"];
            state.chordRoot = possibleRoots[Math.floor(Math.random() * possibleRoots.length)];
            
            const givenInterval = chordData.intervals.find(int => int.label === givenLabel);
            state.givenNote = calculateNoteName(state.chordRoot, givenInterval);

            const minMidi = 65; // F4
            const maxMidi = 84; // C6
            const givenNoteSemitone = getNoteSemitone(state.givenNote);
            let givenOctave = 4;
            let currentMidi = Tone.Midi(`${state.givenNote.charAt(0)}${givenOctave}`).toMidi() + (givenNoteSemitone - getNoteSemitone(state.givenNote.charAt(0)));

            while (currentMidi < minMidi) {
                givenOctave++;
                currentMidi += 12;
            }
             while (currentMidi > maxMidi) {
                givenOctave--;
                currentMidi -= 12;
            }
            
            state.givenNoteWithOctave = `${state.givenNote}/${givenOctave}`;
            
            const voicingLabels = chordData.voicing_rules[givenLabel];
            state.orderedLabelsForDisplay = voicingLabels.slice(0, state.difficulty === 'basic' ? 3 : 4);
            state.correctNotesWithOctave = [];

            let lastMidi = currentMidi;
            for (let i = 0; i < state.orderedLabelsForDisplay.length; i++) {
                const label = state.orderedLabelsForDisplay[i];
                const interval = chordData.intervals.find(int => int.label === label);
                if (!interval) continue;

                const noteName = calculateNoteName(state.chordRoot, interval);
                const noteSemitone = getNoteSemitone(noteName);
                
                let currentNoteOctave = Math.floor(lastMidi / 12);
                let candidateMidi = currentNoteOctave * 12 + noteSemitone;
                
                if (i > 0 && candidateMidi >= lastMidi) {
                    candidateMidi -= 12;
                    currentNoteOctave--;
                } else if (i === 0) {
                    candidateMidi = lastMidi;
                    currentNoteOctave = givenOctave;
                }

                state.correctNotesWithOctave.push(`${noteName}/${currentNoteOctave}`);
                lastMidi = candidateMidi;
            }

            state.correctNotes = state.correctNotesWithOctave.map(n => n.split('/')[0]);
            state.chordTypeKey = chordTypeKey;
            state.givenIntervalName = givenInterval.name;
            state.givenLabel = givenLabel;
            state.selectedUserNotes = [state.givenNoteWithOctave];
            state.currentExerciseId = `${state.chordRoot}|${chordTypeKey}|${givenLabel}`;
            
            updateDisplay();
            enableButtons();
        }


        async function playCorrectChord() {
            if (!synth) return;
            const notes = state.correctNotesWithOctave.map(n => n.replace('/', '')).filter(Boolean);
            if (notes.length === 0) return;

            const arpeggioNotes = [...notes].sort((a,b) => Tone.Midi(b).toMidi() - Tone.Midi(a).toMidi());
            let time = Tone.now();
            arpeggioNotes.forEach((note) => {
                synth.triggerAttackRelease(note, "8n", time);
                time += 0.15;
            });
            synth.triggerAttackRelease(notes, "2n", time + 0.2);
        }

        function getTodayDateString() {
            const today = new Date();
            const offset = today.getTimezoneOffset()
            const todayWithOffset = new Date(today.getTime() - (offset*60*1000))
            return todayWithOffset.toISOString().split('T')[0];
        }

        function noteToPitchClass(noteWithOctave) {
            if (!noteWithOctave) return null;
            const noteName = noteWithOctave.split('/')[0];
            return getNoteSemitone(noteName);
        }

        function checkAndShowEvaluation() {
            if (state.evaluation.questionsAttemptedInBatch >= state.evaluation.exercisesPerEval) {
                showEvaluationModal();
            }
        }
        
        function completeExercise(status) {
            // Status can be 'correct', 'corrected', 'solution', 'skipped'
            state.stats.totalExercises++;
            
            const isAttempted = status !== 'skipped';

            if (isAttempted) {
                state.evaluation.questionsAttemptedInBatch++;
            }

            const historyStatusMap = {
                'correct': '‚úÖ Correcto',
                'corrected': '‚ö†Ô∏è Corregido',
                'solution': 'üÜò Soluci√≥n',
                'skipped': '‚è≠Ô∏è Omitido'
            };
            
            const exerciseResult = {
                id: state.currentExerciseId,
                chordRoot: state.chordRoot,
                chordCifrado: chordStructures[state.chordTypeKey].cifrado,
                lead: state.givenLabel,
                status: historyStatusMap[status]
            };
            state.stats.sessionHistory.push(exerciseResult);

            updateStatsDisplay();
            
            if (isAttempted) {
                checkAndShowEvaluation();
            }
        }


        function checkAnswer() {
            const userPitchClasses = state.selectedUserNotes.map(noteToPitchClass).filter(pc => pc !== null).sort((a, b) => a - b);
            const correctPitchClasses = state.correctNotesWithOctave.map(noteToPitchClass).filter(pc => pc !== null).sort((a, b) => a - b);
            const isCorrect = JSON.stringify(userPitchClasses) === JSON.stringify(correctPitchClasses);
            
            if (isCorrect) {
                if (state.answerWasShown) {
                    completeExercise('solution'); // Log as 'solution' since they saw the answer
                    showCustomMessage("Correcto", "Respuesta ingresada. Pasando al siguiente ejercicio.", "success");
                } else if (state.failedCurrentExercise) {
                    completeExercise('corrected');
                    showCustomMessage("¬°Corregido!", "Ahora s√≠. Pasando al siguiente ejercicio.", "success");
                } else {
                    state.stats.totalCorrect++;
                    completeExercise('correct');
                    
                    const today = getTodayDateString();
                    if (state.stats.lastPracticeDate !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const offset = yesterday.getTimezoneOffset()
                        const yesterdayWithOffset = new Date(yesterday.getTime() - (offset*60*1000))
                        const yesterdayStr = yesterdayWithOffset.toISOString().split('T')[0];
                        
                        if (state.stats.lastPracticeDate === yesterdayStr) {
                            state.stats.currentStreak++;
                        } else {
                            state.stats.currentStreak = 1;
                        }
                    }
                    showCustomMessage("Correcto", "¬°Felicidades, tu respuesta es correcta!", "success");
                }
                playCorrectChord();
                setTimeout(generateExercise, 2000);
            } else {
                if (!state.failedCurrentExercise) {
                    state.stats.totalIncorrect++;
                    state.failedCurrentExercise = true;
                }
                showCustomMessage("Incorrecto", "Int√©ntalo de nuevo. Tus notas no coinciden.", "error");
                updateStatsDisplay();
            }
        }

        function updateStatsDisplay() {
            updateScoreDisplay();
            updateStreakDisplay();
        }
        
        function updateScoreDisplay() {
            scoreCounter.innerHTML = `
                <div class="text-sm text-green-600">‚úÖ ${state.stats.totalCorrect}</div>
                <div class="text-sm text-red-600">‚ùå ${state.stats.totalIncorrect}</div>
            `;
        }

        function updateStreakDisplay() {
            streakCounter.textContent = state.stats.currentStreak;
        }

        function giveHint() {
            state.stats.hintsUsed++;
            updateStatsDisplay();
            
            const correctNoteNames = state.correctNotes.sort();
            const userNoteNames = state.selectedUserNotes.map(n => n ? n.split('/')[0] : '').sort();
            const missingNote = correctNoteNames.find(note => note && !userNoteNames.includes(note));

            let hintText;
            if (missingNote) {
                let noteNameToDisplay = displayNote(missingNote);
                hintText = `La nota <strong>${noteNameToDisplay}</strong> es parte del acorde.`;
            } else {
                hintText = "Ya tienes todas las notas correctas en cuanto a su nombre. ¬°Verifica las alteraciones y las octavas!";
            }

            hintModalBody.innerHTML = `<p>${hintText}</p>`;
            hintModalOverlay.classList.add('visible');
        }

        function showAnswer() {
            state.stats.answersUsed++;
            state.stats.currentStreak = 0; 
            if (!state.failedCurrentExercise) {
                state.stats.totalIncorrect++;
                state.failedCurrentExercise = true;
            }
            updateStatsDisplay();
            
            playCorrectChord();
            state.answerWasShown = true;
            
            infoModalTitle.textContent = 'Respuesta Correcta';
            const chordData = chordStructures[state.chordTypeKey];
            const voicingFormula = chordData.voicing_rules[state.givenLabel].slice(0, state.difficulty === 'basic' ? 3 : 4).join(' - ');
            const notesList = state.correctNotes.map(n => `<li>${displayNote(n)}</li>`).join('');

            infoModalBody.innerHTML = `
                <p class="font-semibold">F√≥rmula de Voicing:</p>
                <p class="mb-4">${voicingFormula}</p>
                <p class="font-semibold">Notas del Acorde:</p>
                <ul class="list-disc list-inside">${notesList}</ul>
            `;
            infoModalOverlay.classList.add('visible');
        }

        function clearSelection() {
            state.selectedUserNotes = [state.givenNoteWithOctave];
            updateDisplay();
        }

        function updateDisplay() {
            updateQuestionText();
            gridCells.forEach((cell, index) => {
                const intervalLabel = cell.querySelector('.interval-label');
                const noteDisplay = cell.querySelector('.note-display');
                if (state.orderedLabelsForDisplay[index]) {
                    cell.classList.remove('hidden');
                    intervalLabel.textContent = state.orderedLabelsForDisplay[index];
                    const note = state.selectedUserNotes[index]?.split('/')[0];
                    noteDisplay.textContent = index === 0 ? displayNote(state.givenNote) : (note ? displayNote(note) : "?");
                } else {
                    cell.classList.add('hidden');
                }
            });
            drawMusicalStaff(state.selectedUserNotes);
            updateButtonStates();
            updatePianoHighlight();
        }
        
        function updateButtonStates() {
            const expectedCount = state.difficulty === 'basic' ? 3 : 4;
            confirmAnswerButton.disabled = state.selectedUserNotes.length !== expectedCount;
            clearAllSelectionButton.disabled = state.selectedUserNotes.length <= 1;
            
            document.querySelectorAll('.note-button.active').forEach(btn => btn.classList.remove('active'));
            
            const lastNote = state.selectedUserNotes[state.selectedUserNotes.length - 1];
            if (state.selectedUserNotes.length > 1 && lastNote) {
                const noteOnly = lastNote.split('/')[0];
                const naturalPartMatch = noteOnly.match(/[A-G]/i);
                if (naturalPartMatch) {
                    const naturalPart = naturalPartMatch[0].toUpperCase();
                    const accidentalPart = noteOnly.substring(naturalPart.length);
                    
                    const naturalBtn = document.querySelector(`.note-button[data-note="${naturalPart}"]`);
                    if (naturalBtn) naturalBtn.classList.add('active');
                    
                    if (accidentalPart) {
                        const accidentalBtn = document.querySelector(`.note-button[data-accidental="${accidentalPart}"]`);
                        if (accidentalBtn) accidentalBtn.classList.add('active');
                    }
                }
            }
        }
        
        function updatePianoHighlight() {
            document.querySelectorAll('.piano-key').forEach(key => {
                key.classList.remove('selected', 'given-note-highlight');
            });
            
            function findPianoKeyByMidi(noteWithOctave) {
                if (!noteWithOctave) return null;
                try {
                    const midiNumber = Tone.Midi(noteWithOctave.replace('/', '')).toMidi();
                    return document.querySelector(`.piano-key[data-midi="${midiNumber}"]`);
                } catch (e) {
                    console.error(`Invalid note format for MIDI conversion: ${noteWithOctave}`, e);
                    return null;
                }
            }
            
            if (state.givenNoteWithOctave) {
                const givenKey = findPianoKeyByMidi(state.givenNoteWithOctave);
                if (givenKey) {
                    givenKey.classList.add('given-note-highlight');
                }
            }
            
            state.selectedUserNotes.forEach(noteWithOctave => {
                if (!noteWithOctave || noteWithOctave === state.givenNoteWithOctave) return;
                const key = findPianoKeyByMidi(noteWithOctave);
                if (key) { key.classList.add('selected'); }
            });
        }
        
        function handleNaturalNoteClick(e) {
            const clickedNote = e.target.dataset.note;
            addNaturalNote(clickedNote);
        }
        
        function addNaturalNote(note) {
            const lastNoteIndex = state.selectedUserNotes.length - 1;
            const expectedCount = state.difficulty === 'basic' ? 3 : 4;

            if (lastNoteIndex >= 1) {
                const lastNote = state.selectedUserNotes[lastNoteIndex];
                if(lastNote){
                    const naturalPartOfLastNote = lastNote.match(/[A-G]/i)[0].toUpperCase();
                    if (naturalPartOfLastNote === note) {
                        state.selectedUserNotes.pop();
                        updateDisplay();
                        return;
                    }
                }
            }

            if (state.selectedUserNotes.length >= expectedCount) {
                showCustomMessage("L√≠mite de notas", `Ya has seleccionado las ${expectedCount} notas.`, "warning");
                return;
            }

            const lastNoteWithOctave = state.selectedUserNotes[lastNoteIndex];
            const lastMidi = Tone.Midi(lastNoteWithOctave.replace('/', '')).toMidi();
            
            let currentOctave = parseInt(lastNoteWithOctave.split('/')[1]);
            let candidateMidi = Tone.Midi(`${note}${currentOctave}`).toMidi();

            while(candidateMidi >= lastMidi) {
                currentOctave--;
                candidateMidi = Tone.Midi(`${note}${currentOctave}`).toMidi();
            }

            const noteWithOctave = `${note}/${currentOctave}`;
            state.selectedUserNotes.push(noteWithOctave);
            updateDisplay();
        }
        
        function handleAccidentalClick(e) {
            const accidental = e.target.dataset.accidental;
            addAccidental(accidental);
        }

        function addAccidental(accidental) {
            const lastNoteIndex = state.selectedUserNotes.length - 1;

            if (lastNoteIndex < 1) { return; }
            
            const lastNote = state.selectedUserNotes[lastNoteIndex];
            const naturalPartMatch = lastNote.match(/[A-G]/i);
             if (!naturalPartMatch) return;

            const naturalPart = naturalPartMatch[0];
            const octavePart = lastNote.match(/\/(\d+)/)[1];
            state.selectedUserNotes[lastNoteIndex] = `${naturalPart}${accidental}/${octavePart}`;
            updateDisplay();
        }

        function handleAccidentalKeyPress(key) {
            const now = Date.now();
            const { lastAccidentalKey, lastAccidentalTimestamp, doublePressThreshold } = state.keyboard;
            
            let accidental = '';

            if (key === lastAccidentalKey && (now - lastAccidentalTimestamp < doublePressThreshold)) {
                accidental = key === '+' ? '##' : 'bb';
                state.keyboard.lastAccidentalKey = null;
                state.keyboard.lastAccidentalTimestamp = 0;
            } else {
                accidental = key === '+' ? '#' : 'b';
                state.keyboard.lastAccidentalKey = key;
                state.keyboard.lastAccidentalTimestamp = now;
            }
            addAccidental(accidental);
        }

        function handleKeyPress(e) {
            if (e.target.tagName === 'INPUT') return;
            if (document.querySelector('.modal-overlay.visible')) return;

            const key = e.key.toLowerCase();
            
            if (['a', 'b', 'c', 'd', 'e', 'f', 'g'].includes(key)) {
                e.preventDefault();
                addNaturalNote(key.toUpperCase());
            }

            if (key === '+' || key === '-') {
                e.preventDefault();
                handleAccidentalKeyPress(key);
            }
            
            if (['1', '2', '3'].includes(key)) {
                e.preventDefault();
                const difficultyId = `difficulty${key === '1' ? 'Basic' : (key === '2' ? 'Intermediate' : 'Advanced')}`;
                const radio = document.getElementById(difficultyId);
                if (radio && !radio.checked) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));
                }
            }


            switch(key) {
                case 'enter':
                    e.preventDefault();
                    if(!confirmAnswerButton.disabled) confirmAnswerButton.click();
                    break;
                case 'p':
                    e.preventDefault();
                    if(!hintButton.disabled) hintButton.click();
                    break;
                case 'r':
                    e.preventDefault();
                    if(!showAnswerButton.disabled) showAnswerButton.click();
                    break;
                case ' ':
                    e.preventDefault();
                    if(!changeQuestionButton.disabled) changeQuestionButton.click();
                    break;
                case 'n':
                    e.preventDefault();
                    if(!clearAllSelectionButton.disabled) clearAllSelectionButton.click();
                    break;
                case 'q':
                    e.preventDefault();
                    toggleFullscreen();
                    break;
                case 's':
                    e.preventDefault();
                    if(!settingsButton.disabled) settingsButton.click();
                    break;
                case 'h':
                    e.preventDefault();
                    if(!showTutorialButton.disabled) showTutorialButton.click();
                    break;
                case 'i':
                    e.preventDefault();
                    if (noteBuildingControls.classList.contains('hidden')) {
                        cifradoToggle.click();
                    } else {
                        pianoToggle.click();
                    }
                    break;
                case 'u':
                    e.preventDefault();
                    if(!switchUserButton.disabled) switchUserButton.click();
                    break;
                case 'v':
                    e.preventDefault();
                    if(!viewHistoryButton.disabled) viewHistoryButton.click();
                    break;
            }
        }


        function enableButtons() {
            [confirmAnswerButton, clearAllSelectionButton, changeQuestionButton, hintButton, showAnswerButton].forEach(btn => btn.disabled = false);
        }
        
        function openFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
        }

        function closeFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                openFullscreen();
            } else {
                closeFullscreen();
            }
        }
        
        function updateFullscreenIcons() {
            const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
            fullscreenIconOpen.classList.toggle('hidden', isFullscreen);
            fullscreenIconClose.classList.toggle('hidden', !isFullscreen);
            if (state.tutorial.isActive) {
                document.getElementById('tutorialOverlay').style.width = isFullscreen ? '100vw' : '100%';
                document.getElementById('tutorialOverlay').style.height = isFullscreen ? '100vh' : '100%';
            }
        }
        
        function getPerformanceAnalysis() {
            const { sessionHistory } = state.stats;
            const chordStats = {};

            sessionHistory.forEach(item => {
                const chordName = `${item.chordRoot}${item.chordCifrado}`;
                if (!chordStats[chordName]) {
                    chordStats[chordName] = { attempts: 0, correct: 0 };
                }
                if(item.status !== '‚è≠Ô∏è Omitido') {
                    chordStats[chordName].attempts++;
                }
                if(item.status === '‚úÖ Correcto') {
                    chordStats[chordName].correct++;
                }
            });

            const strugglingChords = Object.entries(chordStats)
                .map(([chord, stats]) => ({ chord, accuracy: stats.attempts > 0 ? (stats.correct / stats.attempts) * 100 : 100 }))
                .filter(item => item.accuracy < 70 && item.attempts > 2)
                .sort((a, b) => a.accuracy - b.accuracy);
            
            return strugglingChords;
        }


        // --- Settings and Modal Logic ---
        function populateSettingsModal() {
            chordTypesCheckboxesContainer.innerHTML = '';
            const allChordTypes = Object.keys(chordStructures);
            let relevantChords = [];
            if (state.difficulty === 'basic') {
                relevantChords = allChordTypes.filter(key => chordStructures[key].difficulty === 'basic');
            } else if (state.difficulty === 'intermediate' || state.difficulty === 'advanced') {
                relevantChords = allChordTypes.filter(key => chordStructures[key].difficulty === 'intermediate');
            }
            
            const currentPracticeSettings = state.customPractice[state.difficulty];

            relevantChords.forEach(key => {
                const chord = chordStructures[key];
                const isChecked = !currentPracticeSettings.isActive || currentPracticeSettings.allowedChords.includes(key);
                chordTypesCheckboxesContainer.innerHTML += `
                    <div class="flex items-center">
                        <input type="checkbox" id="chord_${key}" value="${key}" ${isChecked ? 'checked' : ''} class="w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300">
                        <label for="chord_${key}" class="ml-2 text-gray-700">${chord.name}</label>
                    </div>
                `;
            });
            
            leadVoicesSection.classList.toggle('hidden', state.difficulty !== 'advanced');
            leadVoicesCheckboxesContainer.innerHTML = '';
            if (state.difficulty === 'advanced') {
                const allTensions = ['b9', '9', '#9', '11', '#11', 'b13', '13'];
                const availableTensions = new Set();
                relevantChords.forEach(key => {
                    chordStructures[key].intervals.forEach(interval => {
                        if (allTensions.includes(interval.label)) {
                            availableTensions.add(interval.label);
                        }
                    });
                });

                allTensions.forEach(label => {
                    if (availableTensions.has(label)) {
                        const isChecked = !currentPracticeSettings.isActive || currentPracticeSettings.allowedLeads.length === 0 || currentPracticeSettings.allowedLeads.includes(label);
                        leadVoicesCheckboxesContainer.innerHTML += `
                            <div class="flex items-center">
                                <input type="checkbox" id="lead_${label}" value="${label}" ${isChecked ? 'checked' : ''} class="w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300">
                                <label for="lead_${label}" class="ml-2 text-gray-700">${label}</label>
                            </div>
                        `;
                    }
                });
            }
        }
        
        function saveSettings() {
            const allowedChords = Array.from(chordTypesCheckboxesContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            const allowedLeads = Array.from(leadVoicesCheckboxesContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            
            const practiceSettings = state.customPractice[state.difficulty];
            practiceSettings.isActive = true;
            practiceSettings.allowedChords = allowedChords;
            
            if (state.difficulty === 'advanced') {
                practiceSettings.allowedLeads = allowedLeads;
            }
            
            closeSettingsModal();
            generateExercise();
        }

        function openSettingsModal() {
            populateSettingsModal();
            settingsModalOverlay.classList.add('visible');
        }

        function closeSettingsModal() {
            settingsModalOverlay.classList.remove('visible');
        }

        function showEvaluationModal() {
            const totalAttempted = state.stats.totalCorrect + state.stats.totalIncorrect;
            const accuracy = totalAttempted > 0 ? Math.round((state.stats.totalCorrect / totalAttempted) * 100) : 0;
            evaluationSummary.textContent = `Has completado ${state.evaluation.questionsAttemptedInBatch} ejercicios. Tu precisi√≥n general en la sesi√≥n es del ${accuracy}%.`;
            
            const strugglingChords = getPerformanceAnalysis();
            if (strugglingChords.length > 0) {
                 adviceList.innerHTML = `<li>Hemos notado que tienes dificultades con los acordes <strong>${strugglingChords[0].chord}</strong>. Te sugerimos usar los Ajustes (S) para practicar este tipo de acorde espec√≠ficamente.</li>`;
            } else {
                 adviceList.innerHTML = `<li>¬°Vas muy bien! Sigue practicando para mejorar tu velocidad y precisi√≥n.</li>`;
            }
            if (accuracy < 70) {
                 adviceList.innerHTML += `<li>Tu precisi√≥n es un poco baja. Considera practicar en un nivel de dificultad menor o enfocarte en menos tipos de acordes a la vez.</li>`;
            }

            state.evaluation.questionsAttemptedInBatch = 0;
            evaluationModalOverlay.classList.add('visible');
        }

        function populateStatsView(container, chartInstance, isFinalView) {
            const { totalExercises, totalCorrect, totalIncorrect, hintsUsed, answersUsed } = state.stats;
            const accuracy = (totalCorrect + totalIncorrect) > 0 ? Math.round((totalCorrect / (totalCorrect + totalIncorrect)) * 100) : 0;
            
            const statsHTML = `
                <div class="flex flex-col items-center mb-4">
                    <label class="text-lg font-semibold text-gray-800 mb-1">Nombre:</label>
                    <input type="text" value="${state.currentUser}" class="text-center p-2 border rounded-lg w-full max-w-sm" readonly>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                    <div class="flex flex-col items-center bg-white p-4 rounded-lg shadow-sm"><span class="text-xs text-gray-500">Ejercicios</span><span class="text-2xl font-bold text-gray-800">${totalExercises}</span></div>
                    <div class="flex flex-col items-center bg-white p-4 rounded-lg shadow-sm"><span class="text-xs text-gray-500">Aciertos</span><span class="text-2xl font-bold text-green-600">${totalCorrect}</span></div>
                    <div class="flex flex-col items-center bg-white p-4 rounded-lg shadow-sm"><span class="text-xs text-gray-500">Desaciertos</span><span class="text-2xl font-bold text-red-600">${totalIncorrect}</span></div>
                    <div class="flex flex-col items-center bg-white p-4 rounded-lg shadow-sm"><span class="text-xs text-gray-500">Precisi√≥n</span><span class="text-2xl font-bold text-blue-600">${accuracy}%</span></div>
                    <div class="flex flex-col items-center bg-white p-4 rounded-lg shadow-sm"><span class="text-xs text-gray-500">Pistas</span><span class="text-2xl font-bold text-yellow-600">${hintsUsed}</span></div>
                    <div class="flex flex-col items-center bg-white p-4 rounded-lg shadow-sm"><span class="text-xs text-gray-500">Soluciones</span><span class="text-2xl font-bold text-red-600">${answersUsed}</span></div>
                </div>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-r-lg"><p class="font-bold">Sugerencia de Pr√°ctica:</p><p id="suggestionText-${isFinalView ? 'final' : 'modal'}"></p></div>
                <p class="text-lg font-bold text-gray-800 mt-4 mb-2">Historial Estad√≠stico por Acorde</p>
                <div class="bg-white p-4 rounded-lg w-full h-80 relative"><canvas id="chartCanvas-${isFinalView ? 'final' : 'modal'}"></canvas></div>
                <div class="flex justify-center gap-4 text-sm text-gray-500 mt-4">
                    <span id="sessionDateDisplay-${isFinalView ? 'final' : 'modal'}"></span><span id="sessionTimeDisplay-${isFinalView ? 'final' : 'modal'}"></span><span id="sessionDurationDisplay-${isFinalView ? 'final' : 'modal'}"></span>
                </div>`;
            container.innerHTML = statsHTML;

            const suggestionEl = document.getElementById(`suggestionText-${isFinalView ? 'final' : 'modal'}`);
            const strugglingChords = getPerformanceAnalysis();
            if (strugglingChords.length > 0) {
                suggestionEl.textContent = `Tu √°rea principal a mejorar son los acordes ${strugglingChords.map(c=>c.chord).join(', ')}. ¬°Enf√≥cate en ellos en tu pr√≥xima sesi√≥n!`;
            } else if (accuracy >= 90) {
                suggestionEl.textContent = "¬°Excelente trabajo! Tu precisi√≥n es muy alta. Intenta practicar en un nivel de dificultad m√°s alto o con tipos de acordes m√°s complejos.";
            } else {
                suggestionEl.textContent = "¬°Buen progreso! Sigue practicando para mejorar tu velocidad y precisi√≥n.";
            }

            const historyStats = {};
            state.stats.sessionHistory.forEach(item => {
                const chordName = `${item.chordRoot}${item.chordCifrado}`;
                if (!historyStats[chordName]) {
                    historyStats[chordName] = { correct: 0, corrected: 0, solution: 0, skipped: 0 };
                }
                if (item.status === '‚úÖ Correcto') historyStats[chordName].correct++;
                if (item.status === '‚ö†Ô∏è Corregido') historyStats[chordName].corrected++;
                if (item.status === 'üÜò Soluci√≥n') historyStats[chordName].solution++;
                if (item.status === '‚è≠Ô∏è Omitido') historyStats[chordName].skipped++;
            });

            const chartCanvas = document.getElementById(`chartCanvas-${isFinalView ? 'final' : 'modal'}`);
            if (chartInstance) chartInstance.destroy();
            
            const newChartInstance = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: Object.keys(historyStats),
                    datasets: [
                        { label: 'Correcto', data: Object.values(historyStats).map(d => d.correct), backgroundColor: 'rgba(75, 192, 192, 0.7)' },
                        { label: 'Corregido', data: Object.values(historyStats).map(d => d.corrected), backgroundColor: 'rgba(255, 206, 86, 0.7)' },
                        { label: 'Soluci√≥n', data: Object.values(historyStats).map(d => d.solution), backgroundColor: 'rgba(255, 99, 132, 0.7)' },
                        { label: 'Omitido', data: Object.values(historyStats).map(d => d.skipped), backgroundColor: 'rgba(153, 102, 255, 0.7)' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            const now = new Date();
            document.getElementById(`sessionDateDisplay-${isFinalView ? 'final' : 'modal'}`).textContent = now.toLocaleDateString('es-ES');
            document.getElementById(`sessionTimeDisplay-${isFinalView ? 'final' : 'modal'}`).textContent = now.toLocaleTimeString('es-ES');
            const durationMs = now.getTime() - state.session.startTime;
            const minutes = Math.floor(durationMs / 60000);
            const seconds = Math.round((durationMs % 60000) / 1000);
            document.getElementById(`sessionDurationDisplay-${isFinalView ? 'final' : 'modal'}`).textContent = `Duraci√≥n: ${minutes}m ${seconds}s`;
            
            return newChartInstance;
        }

        function endSession() {
            saveUserData();
            mainAppContainer.classList.add('hidden');
            evaluationModalOverlay.classList.remove('visible');
            finalMessageDisplay.classList.remove('hidden');
            historyChart = populateStatsView(resultsContentToCapture, historyChart, true);
        }
        
        function showHistoryModal() {
            historyModalTitle.textContent = `Historial de Sesi√≥n de ${state.currentUser}`;
            historyModalChart = populateStatsView(historyModalContent, historyModalChart, false);
            historyModalOverlay.classList.add('visible');
        }


        function saveAsPhoto() {
            html2canvas(resultsContentToCapture).then(canvas => {
                const link = document.createElement('a');
                link.download = `resultados-${state.currentUser}-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        
        function saveAsPdf() {
            const { jsPDF } = window.jspdf;
            html2canvas(resultsContentToCapture, {
                onclone: (document) => {
                    const chartCanvas = document.getElementById('historyChartCanvas');
                    const chartInstance = Chart.getChart(chartCanvas);
                    if (chartInstance) {
                        chartInstance.options.animation = false;
                        chartInstance.update();
                    }
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`resultados-${state.currentUser}-${Date.now()}.pdf`);
            });
        }

        function handlePianoKeyClick(event) {
            const keyElement = event.target.closest('.piano-key');
            if (!keyElement) return;

            const noteWithOctave = keyElement.dataset.note;
            if (!noteWithOctave) return;
            
            synth.triggerAttackRelease(noteWithOctave.replace('/', ''), "8n");

            if (noteWithOctave === state.givenNoteWithOctave) {
                showCustomMessage("Nota fija", "No puedes quitar la nota dada.", "info");
                return;
            }

            const isSelected = state.selectedUserNotes.some(n => n === noteWithOctave);
            if (isSelected) {
                state.selectedUserNotes = state.selectedUserNotes.filter(n => n !== noteWithOctave);
            } else {
                const givenNoteMidi = Tone.Midi(state.givenNoteWithOctave.replace('/', '')).toMidi();
                const selectedNoteMidi = Tone.Midi(noteWithOctave.replace('/', '')).toMidi();
                
                if (selectedNoteMidi >= givenNoteMidi) {
                    showCustomMessage("Error de armon√≠a", "Las notas deben estar por debajo de la nota dada.", "warning");
                    return;
                }
                const expectedCount = state.difficulty === 'basic' ? 3 : 4;
                if (state.selectedUserNotes.length < expectedCount) {
                    const note = noteWithOctave.split('/')[0];
                    const enharmonic = enharmonicEquivalents[note];
                    if (enharmonic) {
                        showEnharmonicModal(noteWithOctave);
                    } else {
                        state.selectedUserNotes.push(noteWithOctave);
                    }
                } else {
                    showCustomMessage("L√≠mite de notas", `Ya has seleccionado ${expectedCount} notas.`, "warning");
                }
            }
            updateDisplay();
        }

        function showEnharmonicModal(noteWithOctave) {
            const [note, octave] = noteWithOctave.split('/');
            const enharmonic = enharmonicEquivalents[note];
            if (!enharmonic) {
                 state.selectedUserNotes.push(noteWithOctave);
                 updateDisplay();
                 return;
            }
            
            enharmonicChoicesContainer.innerHTML = `
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" data-note="${note}/${octave}">${displayNote(note)}</button>
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" data-note="${enharmonic}/${octave}">${displayNote(enharmonic)}</button>
            `;
            enharmonicModalOverlay.classList.add('visible');

            const handler = (e) => {
                const selectedNote = e.target.dataset.note;
                state.selectedUserNotes.push(selectedNote);
                enharmonicModalOverlay.classList.remove('visible');
                enharmonicChoicesContainer.innerHTML = '';
                updateDisplay();
            };

            enharmonicChoicesContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', handler, { once: true });
            });
        }
        
        function generateNoteButtons() {
            naturalNoteButtonsContainer.innerHTML = naturalNotes.map(n => `<button class="note-button" data-note="${n}">${displayNote(n)}</button>`).join('');
            accidentalButtonsContainer.innerHTML = accidentals.map(a => `<button class="note-button px-4" data-accidental="${a}">${a}</button>`).join('');
            naturalNoteButtonsContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', handleNaturalNoteClick));
            accidentalButtonsContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', handleAccidentalClick));
        }

        function generatePiano() {
            pianoContainer.innerHTML = '';
            const whiteNotes = ["C", "D", "E", "F", "G", "A", "B"];
            for (let octave = 3; octave <= 5; octave++) {
                whiteNotes.forEach(note => {
                    const key = document.createElement('div');
                    key.className = `piano-key white`;
                    const noteWithOctave = `${note}/${octave}`;
                    key.dataset.note = noteWithOctave;
                    key.dataset.midi = Tone.Midi(noteWithOctave.replace('/', '')).toMidi();
                    pianoContainer.appendChild(key);
                });
            }
            const c6 = document.createElement('div');
            c6.className = `piano-key white`;
            const c6Note = 'C/6';
            c6.dataset.note = c6Note;
            c6.dataset.midi = Tone.Midi(c6Note.replace('/', '')).toMidi();
            pianoContainer.appendChild(c6);

            const blackNotesWithOctave = { "C#/3": "C#/3", "D#/3": "D#/3", "F#/3": "F#/3", "G#/3": "G#/3", "A#/3": "A#/3", "C#/4": "C#/4", "D#/4": "D#/4", "F#/4": "F#/4", "G#/4": "G#/4", "A#/4": "A#/4", "C#/5": "C#/5", "D#/5": "D#/5", "F#/5": "F#/5", "G#/5": "G#/5", "A#/5": "A#/5" };
            for (const note in blackNotesWithOctave) {
                const key = document.createElement('div');
                key.className = `piano-key black`;
                key.dataset.note = note;
                key.dataset.midi = Tone.Midi(note.replace('/', '')).toMidi();
                pianoContainer.appendChild(key);
            }
        }
        
        // --- Tutorial Logic ---
        const tutorialSteps = [
            { id: 'chordQuestionWrapper', title: 'Paso 1: El Ejercicio', text: 'Aqu√≠ se te presentar√° el ejercicio: una nota (melod√≠a) y su funci√≥n dentro de un acorde. Tu objetivo es construir el resto del acorde.' },
            { id: 'displaySection', title: 'Paso 2: √Årea de Respuesta', text: 'Introduce las notas que faltan en la tabla de la izquierda. Tu respuesta se reflejar√° tambi√©n en el pentagrama de la derecha.' },
            { id: 'inputMethodToggle', title: 'Paso 3: M√©todos de Entrada', text: 'Puedes usar los botones de "Cifrado" o el "Piano" virtual. ¬°Usa la tecla (I) para cambiar entre ellos!' },
            { id: 'difficultySelection', title: 'Paso 4: Cambia la Dificultad', text: 'Puedes cambiar el nivel en cualquier momento usando las teclas (1) para B√°sico, (2) para Intermedio y (3) para Avanzado.' },
            { id: 'confirmAnswerButton', title: 'Paso 5: Comprueba tu Respuesta', text: 'Una vez que hayas construido el acorde, presiona "Confirmar" (Enter). ¬°Usa las herramientas de ayuda si lo necesitas!' },
            { id: null, title: 'Atajos de Teclado Completos', text: '<b>A-G:</b> Notas Naturales <br><b>+/-:</b> Sostenidos/Bemoles <br><b>Enter:</b> Confirmar <br><b>P:</b> Pista, <b>R:</b> Respuesta <br><b>Espacio:</b> Cambiar, <b>N:</b> Borrar <br><b>Q:</b> Pantalla Completa <br><b>1,2,3:</b> Dificultad <br><b>I:</b> Cifrado/Piano <br><b>S:</b> Ajustes, <b>H:</b> Ayuda, <b>U:</b> Cambiar Usuario, <b>V:</b> Ver Historial' },
            { id: null, title: '¬°Todo Listo!', text: 'Has completado el tutorial. ¬°Ya puedes comenzar a entrenar! ¬°Mucha suerte!' }
        ];

        function startTutorial() {
            state.tutorial.isActive = true;
            state.tutorial.currentStep = 0;
            document.getElementById('tutorialOverlay').classList.remove('hidden');
            openFullscreen(); // Make tutorial fullscreen
            showTutorialStep();
        }

        function showTutorialStep() {
            const step = tutorialSteps[state.tutorial.currentStep];
            if (!step) {
                endTutorial();
                return;
            }
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            const titleEl = document.getElementById('tutorialTitle');
            const textEl = document.getElementById('tutorialText');
            const nextButton = document.getElementById('tutorialNextButton');
            const modal = document.getElementById('tutorialModal');
            
            titleEl.textContent = step.title;
            textEl.innerHTML = step.text;

            if (step.id) {
                const targetElement = document.getElementById(step.id);
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    targetElement.classList.add('tutorial-highlight');
                    const rect = targetElement.getBoundingClientRect();
                    modal.style.top = `${rect.bottom + 10}px`;
                    modal.style.left = `50%`;
                    modal.style.transform = 'translateX(-50%)';
                    if (rect.bottom + modal.offsetHeight > window.innerHeight - 10) {
                        modal.style.top = `${rect.top - modal.offsetHeight - 10}px`;
                    }
                }, 400); 
            } else {
                modal.style.top = '50%';
                modal.style.left = '50%';
                modal.style.transform = 'translate(-50%, -50%)';
            }
            nextButton.textContent = (state.tutorial.currentStep === tutorialSteps.length - 1) ? '¬°Comenzar a Practicar!' : 'Siguiente';
        }

        function endTutorial() {
            state.tutorial.isActive = false;
            document.getElementById('tutorialOverlay').classList.add('hidden');
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                closeFullscreen();
            }
        }

        document.getElementById('tutorialNextButton').addEventListener('click', () => {
            state.tutorial.currentStep++;
            showTutorialStep();
        });


        // --- User Management ---
        function getInitialState() {
             return {
                stats: {
                    totalExercises: 0, totalCorrect: 0, totalIncorrect: 0,
                    currentStreak: 0, lastPracticeDate: null, hintsUsed: 0,
                    answersUsed: 0, sessionHistory: []
                },
                customPractice: {
                    basic: { isActive: false, allowedChords: [] },
                    intermediate: { isActive: false, allowedChords: [] },
                    advanced: { isActive: false, allowedChords: [], allowedLeads: [] }
                }
            };
        }

        function populateUserSelect() {
            const users = JSON.parse(localStorage.getItem('harmonicBlockProUsers') || '[]');
            userSelect.innerHTML = '<option value="">-- Cargar Perfil --</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });
             userSelect.addEventListener('change', () => {
                deleteUserButton.disabled = !userSelect.value;
            });
        }

        function loadUserData(username) {
            const userDataString = localStorage.getItem(`harmonicBlockProData_${username}`);
            const defaultData = getInitialState();
            
            if (userDataString) {
                const userData = JSON.parse(userDataString);
                // Merge loaded stats and custom practice, keeping defaults for missing properties
                state.stats = { ...defaultData.stats, ...userData.stats };
                state.customPractice = { ...defaultData.customPractice, ...userData.customPractice };
                
                // Streak logic
                const todayStr = getTodayDateString();
                const lastDate = state.stats.lastPracticeDate;
                 if (lastDate !== todayStr) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const offset = yesterday.getTimezoneOffset();
                    const yesterdayWithOffset = new Date(yesterday.getTime() - (offset*60*1000));
                    const yesterdayStr = yesterdayWithOffset.toISOString().split('T')[0];
                    if (lastDate !== yesterdayStr) {
                        state.stats.currentStreak = 0; // Reset if older than yesterday
                    }
                 }
            } else {
                state.stats = defaultData.stats;
                state.customPractice = defaultData.customPractice;
            }
            state.stats.sessionHistory = []; // Reset session history for the new session
            state.evaluation.questionsAttemptedInBatch = 0;
        }

        function saveUserData() {
            if (!state.currentUser || state.currentUser === "Invitado") return;
            state.stats.lastPracticeDate = getTodayDateString();
            const dataToSave = {
                stats: state.stats,
                customPractice: state.customPractice
            };
            localStorage.setItem(`harmonicBlockProData_${state.currentUser}`, JSON.stringify(dataToSave));
        }

        function confirmDeleteUser() {
            const userToDelete = userSelect.value;
            if (!userToDelete) return;
            deleteConfirmText.innerHTML = `¬øEst√°s seguro de que quieres eliminar el perfil de <strong>${userToDelete}</strong>? Esta acci√≥n no se puede deshacer.`;
            deleteConfirmModalOverlay.classList.add('visible');

            confirmDeleteButton.onclick = () => {
                let users = JSON.parse(localStorage.getItem('harmonicBlockProUsers') || '[]');
                users = users.filter(user => user !== userToDelete);
                localStorage.setItem('harmonicBlockProUsers', JSON.stringify(users));
                localStorage.removeItem(`harmonicBlockProData_${userToDelete}`);
                
                populateUserSelect();
                deleteConfirmModalOverlay.classList.remove('visible');
                showCustomMessage("√âxito", `El perfil de ${userToDelete} ha sido eliminado.`, "success");
            };
        }

        function handleLogin() {
            const selectedUser = userSelect.value;
            const newUser = newUserInput.value.trim();
            const username = newUser || selectedUser;

            if (!username) {
                showCustomMessage("Error", "Por favor, selecciona o crea un perfil.", "error");
                return;
            }

            if (username.toLowerCase() === 'invitado') {
                showCustomMessage("Nombre Reservado", "Elige un nombre de perfil diferente.", "error");
                newUserInput.value = '';
                return;
            }

            state.currentUser = username;
            
            if (newUser) {
                let users = JSON.parse(localStorage.getItem('harmonicBlockProUsers') || '[]');
                if (!users.includes(newUser)) {
                    users.push(newUser);
                    localStorage.setItem('harmonicBlockProUsers', JSON.stringify(users));
                }
            }
            
            loadUserData(username);
            currentUserName.textContent = username;
            welcomeModalOverlay.classList.remove('visible');

            if (state.stats.totalExercises === 0) {
                 tutorialUserName.textContent = username;
                 tutorialPromptModalOverlay.classList.add('visible');
            } else {
                 initializeApp(false);
            }
        }

        function handleGuestLogin() {
            state.currentUser = "Invitado";
            currentUserName.textContent = "Invitado";
            
            const defaultData = getInitialState();
            state.stats = defaultData.stats;
            state.customPractice = defaultData.customPractice;
            state.stats.sessionHistory = []; 
            state.evaluation.questionsAttemptedInBatch = 0;
            
            welcomeModalOverlay.classList.remove('visible');
            initializeApp(false); 
        }

        function handleSwitchUser() {
            saveUserData();
            mainAppListenersAttached = false; // Allow listeners to be re-attached for the next session
            mainAppContainer.classList.add('hidden');
            finalMessageDisplay.classList.add('hidden');
            showLoginScreen();
        }

        function showLoginScreen() {
            mainAppListenersAttached = false;
            mainAppContainer.classList.add('hidden');
            finalMessageDisplay.classList.add('hidden');
            welcomeModalOverlay.classList.add('visible');
            newUserInput.value = '';
            populateUserSelect();
        }

        // --- Initial Events ---
        
        document.addEventListener('DOMContentLoaded', () => {
            assignDomElements();

            promptStartTutorial.addEventListener('click', () => initializeApp(true));
            promptSkipTutorial.addEventListener('click', () => initializeApp(false));
            loginButton.addEventListener('click', handleLogin);
            guestLoginButton.addEventListener('click', handleGuestLogin);
            
            showLoginScreen();
        });
        
    </script>
</body>
</html>

