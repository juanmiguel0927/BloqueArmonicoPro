<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloque Arm√≥nico Pro: Herramienta de Entrenamiento</title>
    <!-- External libraries for musical and UI functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/vexflow/build/esm/vexflow.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Tailwind CSS for a modern and responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Base document styles */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f1f5f9;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            color: #334155;
            line-height: 1.6;
        }

        /* Main application container */
        .container {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 98%;
            box-sizing: border-box;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }

        /* Styles for the question area */
        #chordQuestionWrapper {
            text-align: center;
        }
        #chordQuestionText strong {
            color: #1e40af;
        }

        /* Container for the staff and note grid */
        #displaySection {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 1rem;
        }

        #questionArea {
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid #dbeafe;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1 1 250px;
        }

        #staffArea {
            flex: 1 1 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
        }
        #musicalStaffCanvas {
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            height: auto;
            max-width: 300px; /* Constrains the display width */
            box-sizing: border-box;
        }

        /* Note grid styles */
        .notes-grid {
            display: grid;
            grid-template-rows: repeat(4, 1fr);
            gap: 4px;
            width: 100%;
            max-width: 200px;
        }
        .grid-cell {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            font-weight: 600;
        }
        .grid-cell .note-display {
            font-size: 1.5em;
        }
        .grid-cell.hidden {
            display: none;
        }

        /* Interaction button styles */
        .action-buttons-group, .modal-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
        }
        .action-buttons-group button, .modal-buttons button {
            flex: 1 1 auto;
            min-width: 120px;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            touch-action: manipulation;
        }

        .action-buttons-group button:disabled, .note-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .note-button.active, .toggle-button.active {
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(-1px);
            background-color: #3b82f6;
            color: white;
        }

        /* Note button styles */
        .note-building-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .natural-note-buttons, .accidental-buttons {
            display: grid;
            gap: 0.5rem;
        }
        .natural-note-buttons {
            grid-template-columns: repeat(auto-fit, minmax(3.5rem, 1fr));
        }
        .accidental-buttons {
            grid-template-columns: repeat(4, 1fr);
            max-width: 200px;
            margin: 0 auto;
        }
        .note-button {
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 600;
            background-color: #e2e8f0;
            border: 1px solid #cbd5e1;
            color: #475569;
            transition: all 0.2s;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.visible {
            display: flex;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        /* Feedback message styles */
        .feedback.correct {
            background-color: #dcfce7;
            color: #15803d;
            border: 1px solid #15803d;
        }
        .feedback.incorrect {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #b91c1c;
        }

        /* Piano styles */
        .piano-container {
            position: relative;
            display: flex;
            height: 200px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        .piano-key {
            border: 1px solid #64748b;
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        .piano-key.white {
            background-color: #ffffff;
            width: calc(100% / 22);
            height: 100%;
            border-radius: 0 0 5px 5px;
        }
        .piano-key.black {
            background-color: #334155;
            width: 3%;
            height: 65%;
            position: absolute;
            z-index: 2;
            transform: translateX(-50%);
            border-radius: 0 0 5px 5px;
        }
        /* Black key positions */
        .piano-key.black[data-note="C#/3"] { left: calc(100% / 22 * 1); }
        .piano-key.black[data-note="D#/3"] { left: calc(100% / 22 * 2); }
        .piano-key.black[data-note="F#/3"] { left: calc(100% / 22 * 4); }
        .piano-key.black[data-note="G#/3"] { left: calc(100% / 22 * 5); }
        .piano-key.black[data-note="A#/3"] { left: calc(100% / 22 * 6); }
        .piano-key.black[data-note="C#/4"] { left: calc(100% / 22 * 8); }
        .piano-key.black[data-note="D#/4"] { left: calc(100% / 22 * 9); }
        .piano-key.black[data-note="F#/4"] { left: calc(100% / 22 * 11); }
        .piano-key.black[data-note="G#/4"] { left: calc(100% / 22 * 12); }
        .piano-key.black[data-note="A#/4"] { left: calc(100% / 22 * 13); }
        .piano-key.black[data-note="C#/5"] { left: calc(100% / 22 * 15); }
        .piano-key.black[data-note="D#/5"] { left: calc(100% / 22 * 16); }
        .piano-key.black[data-note="F#/5"] { left: calc(100% / 22 * 18); }
        .piano-key.black[data-note="G#/5"] { left: calc(100% / 22 * 19); }
        .piano-key.black[data-note="A#/5"] { left: calc(100% / 22 * 20); }
        
        .piano-key.selected {
            background-color: #3b82f6 !important;
        }

        /* Tutorial Styles */
        #tutorialOverlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 2000;
        }
        #tutorialModal {
            position: absolute;
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 350px;
            width: 90%;
            border: 2px solid #3b82f6;
        }
        .tutorial-highlight {
            position: relative;
            z-index: 2001;
            box-shadow: 0 0 0 4px #3b82f6, 0 0 20px 10px rgba(59, 130, 246, 0.7);
            border-radius: 8px;
            transition: box-shadow 0.3s ease-in-out;
        }

        /* Responsive design for mobile devices */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                gap: 0.75rem;
                margin-top: 0.5rem;
            }
            .action-buttons-group, .modal-buttons {
                flex-direction: column;
            }
            .action-buttons-group button, .modal-buttons button {
                width: 100%;
            }
             #displaySection {
                flex-direction: row;
                gap: 0.5rem;
                align-items: stretch;
            }
            #questionArea {
                flex: 0 0 40%;
                min-width: 0;
                padding: 0.5rem;
            }
            #staffArea {
                flex: 0 0 58%;
                min-width: 0;
                padding: 0.25rem;
            }
            #questionArea p {
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }
            .notes-grid {
                max-width: none;
                gap: 2px;
            }
            .grid-cell {
                padding: 0.25rem 0.5rem;
                font-size: 0.8em;
            }
            .grid-cell .note-display {
                font-size: 1.2em;
            }
            #musicalStaffCanvas {
                height: auto; /* Let aspect ratio define height */
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center">
    <!-- Initial welcome modal -->
    <div id="welcomeModalOverlay" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-lg w-11/12">
            <h2 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-4">Bienvenido a Bloque Arm√≥nico Pro</h2>
            <p class="text-lg text-gray-700 mb-6">Una herramienta para desarrollar tu t√©cnica de armonizaci√≥n en bloques cerrados (4-way closed).</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="startTutorialButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors">Ver Tutorial</button>
                <button id="skipTutorialButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors">Omitir y Empezar</button>
            </div>
        </div>
    </div>

    <!-- Interactive Tutorial -->
    <div id="tutorialOverlay" class="hidden">
        <div id="tutorialModal">
            <h3 id="tutorialTitle" class="text-xl font-bold text-blue-800 mb-2"></h3>
            <p id="tutorialText" class="text-gray-700 mb-4"></p>
            <button id="tutorialNextButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Siguiente</button>
        </div>
    </div>

    <!-- Main application container, hidden initially -->
    <div id="mainAppContainer" class="container hidden">
        <div class="flex flex-col items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-center">Bloque Arm√≥nico Pro</h1>
            <div id="chordQuestionWrapper" class="text-lg text-gray-700 mt-2">
                <p id="chordQuestionText">
                    <strong class="text-xl sm:text-2xl"></strong> es <strong class="text-xl sm:text-2xl"></strong> de un acorde <strong class="text-xl sm:text-2xl"></strong>.<br>
                    <small class="text-sm text-gray-500">Armoniza en bloque cerrado, <span class="font-bold text-indigo-700">4 voces</span>, descendente.</small>
                </p>
            </div>
        </div>

        <!-- Status bar (streak and score) -->
        <div class="flex justify-between items-center mb-4 p-2 bg-gray-50 rounded-lg">
            <div id="streakCounter" class="flex flex-col items-center p-2 rounded-xl bg-amber-50 border border-amber-200">
                <div class="text-xs font-medium text-amber-600">üî• D√≠as de Racha</div>
                <div class="text-xl font-bold text-amber-800">0</div>
            </div>
            <div id="scoreCounter" class="flex flex-col


